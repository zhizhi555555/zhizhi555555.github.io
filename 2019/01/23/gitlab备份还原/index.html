<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="我是程序猿"><title>gitlab备份还原 | 朝阳</title><link rel="stylesheet" type="text/css" href="//fonts.loli.net/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style-dark.css?v=2.0.3"><link rel="stylesheet" type="text/css" href="/css/highlight-dark.css?v=2.0.3"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css?v=2.0.3"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js?v=2.0.3"></script><script src="//cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js?v=2.0.3"></script></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">gitlab备份还原</h1><a id="logo" href="/.">朝阳</a><p class="description">前方是绝路，希望在转角</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 主页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="搜索"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">gitlab备份还原</h1><div class="post-meta"><a href="/2019/01/23/gitlab备份还原/#comments" class="comment-count"></a><p><span class="date">Jan 23, 2019</span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i>点击</i></i></span></p></div><div class="post-content"><h3 id="备份跟还原-GitLab"><a href="#备份跟还原-GitLab" class="headerlink" title="备份跟还原 GitLab"></a>备份跟还原 GitLab</h3><p>应用数据备份创建的压缩文件包含了数据库，所有代码仓库和所有附件。<br>你可以在另一个利用同一个版本的gitLab中回复。<br>通过备份跟恢复是迁移你的仓库从一个服务器到另一个的最好的方式。</p>
<h4 id="需要条件"><a href="#需要条件" class="headerlink" title="需要条件"></a>需要条件</h4><p>为了能够备份跟恢复，你需要在你的系统中安装2个必要的工具。</p>
<h5 id="Rsync-远程同步工具"><a href="#Rsync-远程同步工具" class="headerlink" title="Rsync(远程同步工具)"></a>Rsync(远程同步工具)</h5><p>如果你已经安装了GitLab:<br> 利用OmniBus包<br> 确保rsync都安装</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># Debian/Ubuntu</span><br><span class="line">sudo apt-get install rsync</span><br><span class="line"># RHEL/CentOS</span><br><span class="line">sudo yum install rsync</span><br></pre></td></tr></table></figure>
<h5 id="Tar"><a href="#Tar" class="headerlink" title="Tar"></a>Tar</h5><p>确保Tar命令在1.3.0以上<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar --version</span><br></pre></td></tr></table></figure></p>
<h5 id="备份timestamp"><a href="#备份timestamp" class="headerlink" title="备份timestamp"></a>备份timestamp</h5><blockquote>
<p>在 GitLab 9.2 the timestamp 格式变了从<br>EPOCH_YYYY_MM_DD 到 EPOCH_YYYY_MM_DD_GitLab_version,<br>比如 1493107454_2018_04_25 会变成 1493107454_2018_04_25_10.6.4-ce.</p>
</blockquote>
<h5 id="Gitlab的备份目录路径设置"><a href="#Gitlab的备份目录路径设置" class="headerlink" title="Gitlab的备份目录路径设置"></a>Gitlab的备份目录路径设置</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@code-server ~]# vim /etc/gitlab/gitlab.rb</span><br><span class="line">gitlab_rails[&apos;manage_backup_path&apos;] = true</span><br><span class="line">gitlab_rails[&apos;backup_path&apos;] = &quot;/data/gitlab/backups&quot;    //gitlab备份目录</span><br><span class="line">gitlab_rails[&apos;backup_archive_permissions&apos;] = 0644       //生成的备份文件权限</span><br><span class="line">gitlab_rails[&apos;backup_keep_time&apos;] = 7776000              //备份保留天数为3个月（即90天，这里是7776000秒）</span><br><span class="line"> </span><br><span class="line">[root@code-server ~]# mkdir -p /data/gitlab/backups</span><br><span class="line">[root@code-server ~]# chown -R git.git /data/gitlab/backups</span><br><span class="line">[root@code-server ~]# chmod -R 777 /data/gitlab/backups</span><br><span class="line">  </span><br><span class="line">如上设置了gitlab备份目录路径为/data/gitlab/backups，最后使用下面命令重载gitlab配置文件，是上述修改生效！</span><br><span class="line">root@code-server ~]# gitlab-ctl reconfigure</span><br></pre></td></tr></table></figure>
<h5 id="GItlab备份操作（使用备份命令”gitlab-rake-gitlab-backup-create”）"><a href="#GItlab备份操作（使用备份命令”gitlab-rake-gitlab-backup-create”）" class="headerlink" title="GItlab备份操作（使用备份命令”gitlab-rake gitlab:backup:create”）"></a>GItlab备份操作（使用备份命令”gitlab-rake gitlab:backup:create”）</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">手动备份gitlab</span><br><span class="line">[root@code-server backups]# gitlab-rake gitlab:backup:create</span><br><span class="line">Dumping database ...</span><br><span class="line">Dumping PostgreSQL database gitlabhq_production ... [DONE]</span><br><span class="line">done</span><br><span class="line">Dumping repositories ...</span><br><span class="line"> * treesign/treesign ... [DONE]</span><br><span class="line"> * gateway/gateway ... [DONE]</span><br><span class="line"> * treesign/treesign-doc ... [SKIPPED]</span><br><span class="line"> * qwsign/qwsign ... [DONE]</span><br><span class="line"> * qwsign/qwsign-doc ... [DONE]</span><br><span class="line"> * test/test ... [DONE]</span><br><span class="line">done</span><br><span class="line">Dumping uploads ...</span><br><span class="line">done</span><br><span class="line">Dumping builds ...</span><br><span class="line">done</span><br><span class="line">Dumping artifacts ...</span><br><span class="line">done</span><br><span class="line">Dumping pages ...</span><br><span class="line">done</span><br><span class="line">Dumping lfs objects ...</span><br><span class="line">done</span><br><span class="line">Dumping container registry images ...</span><br><span class="line">[DISABLED]</span><br><span class="line">Creating backup archive: 1510471890_2017_11_12_9.4.5_gitlab_backup.tar ... done</span><br><span class="line">Uploading backup archive to remote storage  ... skipped</span><br><span class="line">Deleting tmp directories ... done</span><br><span class="line">done</span><br><span class="line">done</span><br><span class="line">done</span><br><span class="line">done</span><br><span class="line">done</span><br><span class="line">done</span><br><span class="line">done</span><br><span class="line">Deleting old backups ... done. (0 removed)</span><br><span class="line"> </span><br><span class="line">然后查看下备份文件（文件权限是设定好的644）</span><br><span class="line">[root@code-server backups]# ll</span><br><span class="line">total 244</span><br><span class="line">-rw-r--r-- 1 git git 245760 Nov 12 15:33 1510472027_2017_11_12_9.4.5_gitlab_backup.tar</span><br><span class="line"> </span><br><span class="line">编写备份脚本，结合crontab实施自动定时备份，比如每天0点、6点、12点、18点各备份一次</span><br><span class="line">[root@code-server backups]# pwd</span><br><span class="line">/data/gitlab/backups</span><br><span class="line">[root@code-server backups]# vim gitlab_backup.sh</span><br><span class="line">#!/bin/bash</span><br><span class="line">/usr/bin/gitlab-rake gitlab:backup:create CRON=1</span><br><span class="line"> </span><br><span class="line">注意：环境变量CRON=1的作用是如果没有任何错误发生时， 抑制备份脚本的所有进度输出</span><br><span class="line"> </span><br><span class="line">[root@code-server backups]# crontab -l</span><br><span class="line">0 0,6,12,18 * * * /bin/bash -x /data/gitlab/backups/gitlab_backup.sh &gt; /dev/null 2&gt;&amp;1</span><br></pre></td></tr></table></figure>
<h5 id="Gitlab恢复操作"><a href="#Gitlab恢复操作" class="headerlink" title="Gitlab恢复操作"></a>Gitlab恢复操作</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br></pre></td><td class="code"><pre><span class="line">GItlab只能还原到与备份文件相同的gitlab版本。</span><br><span class="line">假设在上面gitlab备份之前创建了test项目，然后不小心误删了test项目，现在就进行gitlab恢复操作：</span><br><span class="line">  </span><br><span class="line">1）停止相关数据连接服务</span><br><span class="line">[root@code-server backups]# gitlab-ctl stop unicorn</span><br><span class="line">ok: down: unicorn: 0s, normally up</span><br><span class="line">[root@code-server backups]# gitlab-ctl stop sidekiq</span><br><span class="line">ok: down: sidekiq: 1s, normally up</span><br><span class="line">[root@code-server backups]# gitlab-ctl status</span><br><span class="line">run: gitaly: (pid 98087) 1883s; run: log: (pid 194202) 163003s</span><br><span class="line">run: gitlab-monitor: (pid 98101) 1883s; run: log: (pid 194363) 163002s</span><br><span class="line">run: gitlab-workhorse: (pid 98104) 1882s; run: log: (pid 194362) 163002s</span><br><span class="line">run: logrotate: (pid 98117) 1882s; run: log: (pid 5793) 160832s</span><br><span class="line">run: nginx: (pid 98123) 1881s; run: log: (pid 194359) 163002s</span><br><span class="line">run: node-exporter: (pid 98167) 1881s; run: log: (pid 194360) 163002s</span><br><span class="line">run: postgres-exporter: (pid 98173) 1881s; run: log: (pid 194204) 163003s</span><br><span class="line">run: postgresql: (pid 98179) 1880s; run: log: (pid 194365) 163002s</span><br><span class="line">run: prometheus: (pid 98187) 1880s; run: log: (pid 194364) 163002s</span><br><span class="line">run: redis: (pid 98230) 1879s; run: log: (pid 194358) 163002s</span><br><span class="line">run: redis-exporter: (pid 98234) 1879s; run: log: (pid 194208) 163003s</span><br><span class="line">down: sidekiq: 8s, normally up; run: log: (pid 194437) 163001s</span><br><span class="line">down: unicorn: 21s, normally up; run: log: (pid 194443) 163001s</span><br><span class="line">  </span><br><span class="line">2）现在通过之前的备份文件进行恢复（必须要备份文件放到备份路径下，这里备份路径我自定义的/data/gitlab/backups，默认的是/var/opt/gitlab/backups）</span><br><span class="line">[root@code-server backups]# pwd</span><br><span class="line">/data/gitlab/backups</span><br><span class="line">[root@code-server backups]# ll</span><br><span class="line">total 244</span><br><span class="line">-rw-r--r-- 1 git git 245760 Nov 12 15:33 1510472027_2017_11_12_9.4.5_gitlab_backup.tar</span><br><span class="line">  </span><br><span class="line">Gitlab的恢复操作会先将当前所有的数据清空，然后再根据备份数据进行恢复</span><br><span class="line">[root@code-server backups]# gitlab-rake gitlab:backup:restore BACKUP=1510472027_2017_11_12_9.4.5</span><br><span class="line">Unpacking backup ... done</span><br><span class="line">Before restoring the database we recommend removing all existing</span><br><span class="line">tables to avoid future upgrade problems. Be aware that if you have</span><br><span class="line">custom tables in the GitLab database these tables and all data will be</span><br><span class="line">removed.</span><br><span class="line">  </span><br><span class="line">Do you want to continue (yes/no)?</span><br><span class="line">........</span><br><span class="line">ALTER TABLE</span><br><span class="line">ALTER TABLE</span><br><span class="line">ALTER TABLE</span><br><span class="line">ALTER TABLE</span><br><span class="line">WARNING:  no privileges were granted for &quot;public&quot;</span><br><span class="line">GRANT</span><br><span class="line">[DONE]</span><br><span class="line">done</span><br><span class="line">Restoring repositories ...</span><br><span class="line"> * treesign/treesign ... [DONE]</span><br><span class="line"> * gateway/gateway ... [DONE]</span><br><span class="line"> * treesign/treesign-doc ... [DONE]</span><br><span class="line"> * qwsign/qwsign ... [DONE]</span><br><span class="line"> * qwsign/qwsign-doc ... [DONE]</span><br><span class="line"> * test/test ... [DONE]</span><br><span class="line">Put GitLab hooks in repositories dirs [DONE]</span><br><span class="line">done</span><br><span class="line">Restoring uploads ...</span><br><span class="line">done</span><br><span class="line">Restoring builds ...</span><br><span class="line">done</span><br><span class="line">Restoring artifacts ...</span><br><span class="line">done</span><br><span class="line">Restoring pages ...</span><br><span class="line">done</span><br><span class="line">Restoring lfs objects ...</span><br><span class="line">done</span><br><span class="line">This will rebuild an authorized_keys file.</span><br><span class="line">You will lose any data stored in authorized_keys file.</span><br><span class="line">Do you want to continue (yes/no)? yes</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">Deleting tmp directories ... done</span><br><span class="line">done</span><br><span class="line">done</span><br><span class="line">done</span><br><span class="line">done</span><br><span class="line">done</span><br><span class="line">done</span><br><span class="line">done</span><br><span class="line">[root@code-server backups]#</span><br><span class="line">  </span><br><span class="line">最后再次启动Gitlab</span><br><span class="line">[root@code-server backups]# gitlab-ctl start</span><br><span class="line">ok: run: gitaly: (pid 98087) 2138s</span><br><span class="line">ok: run: gitlab-monitor: (pid 98101) 2138s</span><br><span class="line">ok: run: gitlab-workhorse: (pid 98104) 2137s</span><br><span class="line">ok: run: logrotate: (pid 98117) 2137s</span><br><span class="line">ok: run: nginx: (pid 98123) 2136s</span><br><span class="line">ok: run: node-exporter: (pid 98167) 2136s</span><br><span class="line">ok: run: postgres-exporter: (pid 98173) 2136s</span><br><span class="line">ok: run: postgresql: (pid 98179) 2135s</span><br><span class="line">ok: run: prometheus: (pid 98187) 2135s</span><br><span class="line">ok: run: redis: (pid 98230) 2134s</span><br><span class="line">ok: run: redis-exporter: (pid 98234) 2134s</span><br><span class="line">ok: run: sidekiq: (pid 104494) 0s</span><br><span class="line">ok: run: unicorn: (pid 104497) 1s</span><br><span class="line">[root@code-server backups]# gitlab-ctl status</span><br><span class="line">run: gitaly: (pid 98087) 2142s; run: log: (pid 194202) 163262s</span><br><span class="line">run: gitlab-monitor: (pid 98101) 2142s; run: log: (pid 194363) 163261s</span><br><span class="line">run: gitlab-workhorse: (pid 98104) 2141s; run: log: (pid 194362) 163261s</span><br><span class="line">run: logrotate: (pid 98117) 2141s; run: log: (pid 5793) 161091s</span><br><span class="line">run: nginx: (pid 98123) 2140s; run: log: (pid 194359) 163261s</span><br><span class="line">run: node-exporter: (pid 98167) 2140s; run: log: (pid 194360) 163261s</span><br><span class="line">run: postgres-exporter: (pid 98173) 2140s; run: log: (pid 194204) 163262s</span><br><span class="line">run: postgresql: (pid 98179) 2139s; run: log: (pid 194365) 163261s</span><br><span class="line">run: prometheus: (pid 98187) 2139s; run: log: (pid 194364) 163261s</span><br><span class="line">run: redis: (pid 98230) 2138s; run: log: (pid 194358) 163261s</span><br><span class="line">run: redis-exporter: (pid 98234) 2138s; run: log: (pid 194208) 163262s</span><br><span class="line">run: sidekiq: (pid 104494) 4s; run: log: (pid 194437) 163260s</span><br><span class="line">run: unicorn: (pid 104497) 4s; run: log: (pid 194443) 163260s</span><br><span class="line"> </span><br><span class="line">恢复命令完成后，可以check检查一下恢复情况</span><br><span class="line">[root@code-server backups]# gitlab-rake gitlab:check SANITIZE=true</span><br><span class="line">Checking GitLab Shell ...</span><br><span class="line"> </span><br><span class="line">GitLab Shell version &gt;= 5.3.1 ? ... OK (5.3.1)</span><br><span class="line">Repo base directory exists?</span><br><span class="line">default... yes</span><br><span class="line">Repo storage directories are symlinks?</span><br><span class="line">default... no</span><br><span class="line">Repo paths owned by git:root, or git:git?</span><br><span class="line">default... yes</span><br><span class="line">Repo paths access is drwxrws---?</span><br><span class="line">default... yes</span><br><span class="line">hooks directories in repos are links: ...</span><br><span class="line">5/1 ... ok</span><br><span class="line">6/2 ... ok</span><br><span class="line">5/3 ... repository is empty</span><br><span class="line">12/4 ... ok</span><br><span class="line">12/5 ... ok</span><br><span class="line">Running /opt/gitlab/embedded/service/gitlab-shell/bin/check</span><br><span class="line">Check GitLab API access: OK</span><br><span class="line">Access to /var/opt/gitlab/.ssh/authorized_keys: OK</span><br><span class="line">Send ping to redis server: OK</span><br><span class="line">gitlab-shell self-check successful</span><br><span class="line"> </span><br><span class="line">Checking GitLab Shell ... Finished</span><br><span class="line"> </span><br><span class="line">Checking Sidekiq ...</span><br><span class="line"> </span><br><span class="line">Running? ... yes</span><br><span class="line">Number of Sidekiq processes ... 1</span><br><span class="line"> </span><br><span class="line">Checking Sidekiq ... Finished</span><br><span class="line"> </span><br><span class="line">Checking Reply by email ...</span><br><span class="line"> </span><br><span class="line">Reply by email is disabled in config/gitlab.yml</span><br><span class="line"> </span><br><span class="line">Checking Reply by email ... Finished</span><br><span class="line"> </span><br><span class="line">Checking LDAP ...</span><br><span class="line"> </span><br><span class="line">LDAP is disabled in config/gitlab.yml</span><br><span class="line"> </span><br><span class="line">Checking LDAP ... Finished</span><br><span class="line"> </span><br><span class="line">Checking GitLab ...</span><br><span class="line"> </span><br><span class="line">Git configured correctly? ... yes</span><br><span class="line">Database config exists? ... yes</span><br><span class="line">All migrations up? ... yes</span><br><span class="line">Database contains orphaned GroupMembers? ... no</span><br><span class="line">GitLab config exists? ... yes</span><br><span class="line">GitLab config up to date? ... yes</span><br><span class="line">Log directory writable? ... yes</span><br><span class="line">Tmp directory writable? ... yes</span><br><span class="line">Uploads directory exists? ... yes</span><br><span class="line">Uploads directory has correct permissions? ... yes</span><br><span class="line">Uploads directory tmp has correct permissions? ... yes</span><br><span class="line">Init script exists? ... skipped (omnibus-gitlab has no init script)</span><br><span class="line">Init script up-to-date? ... skipped (omnibus-gitlab has no init script)</span><br><span class="line">Projects have namespace: ...</span><br><span class="line">5/1 ... yes</span><br><span class="line">6/2 ... yes</span><br><span class="line">5/3 ... yes</span><br><span class="line">12/4 ... yes</span><br><span class="line">12/5 ... yes</span><br><span class="line">Redis version &gt;= 2.8.0? ... yes</span><br><span class="line">Ruby version &gt;= 2.3.3 ? ... yes (2.3.3)</span><br><span class="line">Git version &gt;= 2.7.3 ? ... yes (2.13.4)</span><br><span class="line">Active users: ... 11</span><br><span class="line"> </span><br><span class="line">Checking GitLab ... Finished</span><br><span class="line">  </span><br><span class="line">然后稍等一会（如果启动gitlab后，访问出现500，这是因为redis等程序还没完全启动，等一会儿访问就ok了），再次登录Gitlab，就会发现之前误删除的test项目已经恢复了！</span><br><span class="line">  </span><br><span class="line">另外：Gitlab迁移与恢复一样，但是要求两个GitLab版本号一致</span><br></pre></td></tr></table></figure>
</div><div class="post-copyright"><blockquote><p>原文作者: 西瓜哥</p><p>原文链接: <a href="http://yoursite.com/2019/01/23/gitlab备份还原/">http://yoursite.com/2019/01/23/gitlab备份还原/</a></p><p>版权声明: 转载请注明出处(必须保留原文作者署名原文链接)</p></blockquote></div><div class="tags"><a href="/tags/gitlab/">gitlab</a></div><div class="post-share"><div class="social-share"><span>分享到:</span></div></div><div class="post-nav"><a href="/2019/01/25/docker常用命令/" class="pre">docker常用命令</a><a href="/2019/01/18/gitlab安装/" class="next">gitlab安装</a></div><div id="comments"></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">文章目录</i></div><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#备份跟还原-GitLab"><span class="toc-text">备份跟还原 GitLab</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#需要条件"><span class="toc-text">需要条件</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Rsync-远程同步工具"><span class="toc-text">Rsync(远程同步工具)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Tar"><span class="toc-text">Tar</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#备份timestamp"><span class="toc-text">备份timestamp</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Gitlab的备份目录路径设置"><span class="toc-text">Gitlab的备份目录路径设置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#GItlab备份操作（使用备份命令”gitlab-rake-gitlab-backup-create”）"><span class="toc-text">GItlab备份操作（使用备份命令”gitlab-rake gitlab:backup:create”）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Gitlab恢复操作"><span class="toc-text">Gitlab恢复操作</span></a></li></ol></li></ol></li></ol></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/07/20/springboot-annotation/">springboot_annotation</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/26/python-db/">python_db</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/16/hello-world/">Hello World</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/16/apollo/">apollo</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/31/jenkins-jacoco/">jenkins_jacoco</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/29/docker-jenkins/">docker_jenkins</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/25/docker-example/">docker example</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/25/docker常用命令/">docker常用命令</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/23/gitlab备份还原/">gitlab备份还原</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/18/gitlab安装/">gitlab安装</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"><a href="/tags/apollo/" style="font-size: 15px;">apollo</a> <a href="/tags/centos7-linux/" style="font-size: 15px;">centos7,linux</a> <a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/docker-jenkins/" style="font-size: 15px;">docker jenkins</a> <a href="/tags/gitLab/" style="font-size: 15px;">gitLab</a> <a href="/tags/linux/" style="font-size: 15px;">linux</a> <a href="/tags/jenkins/" style="font-size: 15px;">jenkins</a> <a href="/tags/gitlab/" style="font-size: 15px;">gitlab</a> <a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/springboot/" style="font-size: 15px;">springboot</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> 归档</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">七月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">四月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">一月 2019</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-you"> 友情链接</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">网站地图</a> |  <a href="/atom.xml">订阅本站</a> |  <a href="/about/">联系博主</a></p><p>本站总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次，本站总访客数:<i id="busuanzi_container_site_uv"><i id="busuanzi_value_site_uv"></i></i>人</p><p><span> Copyright &copy;<a href="/." rel="nofollow">西瓜哥.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Count by<a href="http://busuanzi.ibruce.info/"> busuanzi.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script type="text/javascript" src="/js/search.json.js?v=2.0.3"></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.3" async></script><link rel="stylesheet" type="text/css" href="/share/css/share.css"><script type="text/javascript" src="/share/js/social-share.js" charset="utf-8"></script><script type="text/javascript" src="/share/js/qrcode.js" charset="utf-8"></script></body></html>