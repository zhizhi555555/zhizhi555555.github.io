<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>朝阳</title>
  
  <subtitle>前方是绝路，希望在转角</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://yoursite.com/"/>
  <updated>2019-11-21T01:44:28.405Z</updated>
  <id>http://yoursite.com/</id>
  
  <author>
    <name>西瓜哥</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>linux防火墙开启测试</title>
    <link href="http://yoursite.com/2019/11/21/linux%E9%98%B2%E7%81%AB%E5%A2%99%E5%BC%80%E5%90%AF%E6%B5%8B%E8%AF%95/"/>
    <id>http://yoursite.com/2019/11/21/linux防火墙开启测试/</id>
    <published>2019-11-21T01:36:24.000Z</published>
    <updated>2019-11-21T01:44:28.405Z</updated>
    
    <content type="html"><![CDATA[<h3 id="linux防火墙开启"><a href="#linux防火墙开启" class="headerlink" title="linux防火墙开启"></a>linux防火墙开启</h3><p>1、防火墙</p><blockquote><p>CentOS升级到7之后，发现无法使用iptables控制Linuxs的端口，google之后发现Centos 7使用firewalld代替了原来的iptables。下面记录如何使用firewalld开放Linux端口：</p></blockquote><ol><li>查看防火墙状态<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl status firewalld</span><br></pre></td></tr></table></figure></li></ol><p>2.开启防火墙<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start firewalld</span><br></pre></td></tr></table></figure></p><p>3.关闭防火墙</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld</span><br></pre></td></tr></table></figure><ol start="4"><li>查看当前firewall状态</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --state</span><br></pre></td></tr></table></figure><p>5.重启firewall</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure><ol start="6"><li>禁止开机启动<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl disable firewalld.service</span><br></pre></td></tr></table></figure></li></ol><h4 id="2、开启端口"><a href="#2、开启端口" class="headerlink" title="2、开启端口"></a>2、开启端口</h4><ol><li><p>查看已经开放的端口：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --list-ports</span><br></pre></td></tr></table></figure></li><li><p>开启端口</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --zone=public --add-port=80/tcp --permanent</span><br></pre></td></tr></table></figure></li></ol><p>命令含义：</p><p>–zone #作用域</p><p>–add-port=80/tcp  #添加端口，格式为：端口/通讯协议</p><p>–permanent  #永久生效，没有此参数重启后失效</p><p>开启断绝口后需要重启防火墙</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;linux防火墙开启&quot;&gt;&lt;a href=&quot;#linux防火墙开启&quot; class=&quot;headerlink&quot; title=&quot;linux防火墙开启&quot;&gt;&lt;/a&gt;linux防火墙开启&lt;/h3&gt;&lt;p&gt;1、防火墙&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;CentOS升级到7之后
      
    
    </summary>
    
    
      <category term="linux" scheme="http://yoursite.com/tags/linux/"/>
    
  </entry>
  
  <entry>
    <title>更改gitlab clone的external_url</title>
    <link href="http://yoursite.com/2019/11/20/%E6%9B%B4%E6%94%B9gitlab-clone%E7%9A%84external-url/"/>
    <id>http://yoursite.com/2019/11/20/更改gitlab-clone的external-url/</id>
    <published>2019-11-20T11:01:19.000Z</published>
    <updated>2019-11-20T11:03:09.918Z</updated>
    
    <content type="html"><![CDATA[<h3 id="更改gitlab-clone的external-url"><a href="#更改gitlab-clone的external-url" class="headerlink" title="更改gitlab clone的external_url"></a>更改gitlab clone的external_url</h3><p>在安装gitlab，新建项目之后，默认的clone链接为<a href="mailto:git@gitlab.example" target="_blank" rel="noopener">git@gitlab.example</a>:test/test.git，http也是gitlab.example这种的<br>这样每次clone时候都需要手动改下，改成ip或者域名才可以，<br>可以按照如下方式更改external_url，</p><p>直接更改/etc/gitlab/gitlab.rb不能生效，更改/opt/gitlab/embedded/service/gitlab-rails/config/gitlab.yml文件(centos7)中<br>host和port即可<br>host可以换成域名，port更改为gitlab服务的端口，这里不设置的话在clone http url时候还是不行，需要把端口加上</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">vi /opt/gitlab/embedded/service/gitlab-rails/config/gitlab.yml</span><br><span class="line">  # 1. GitLab app settings</span><br><span class="line">  # ==========================</span><br><span class="line"></span><br><span class="line">  ## GitLab settings</span><br><span class="line">  gitlab:</span><br><span class="line">    ## Web server settings (note: host is the FQDN, do not include http://)</span><br><span class="line">    host: 10.119.116.160</span><br><span class="line">    port: 8181</span><br><span class="line">    https: false</span><br></pre></td></tr></table></figure><p>更改后clone的external_url后执行gitlab-ctl restart，重新进入gitlab就生效了</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;更改gitlab-clone的external-url&quot;&gt;&lt;a href=&quot;#更改gitlab-clone的external-url&quot; class=&quot;headerlink&quot; title=&quot;更改gitlab clone的external_url&quot;&gt;&lt;/a&gt;更改git
      
    
    </summary>
    
    
      <category term="gitLab" scheme="http://yoursite.com/tags/gitLab/"/>
    
  </entry>
  
  <entry>
    <title>mideng</title>
    <link href="http://yoursite.com/2019/11/19/mideng/"/>
    <id>http://yoursite.com/2019/11/19/mideng/</id>
    <published>2019-11-19T08:35:50.000Z</published>
    <updated>2019-11-19T08:37:13.992Z</updated>
    
    <content type="html"><![CDATA[<h2 id="接口幂等性适用场景及设计方法"><a href="#接口幂等性适用场景及设计方法" class="headerlink" title="接口幂等性适用场景及设计方法"></a>接口幂等性适用场景及设计方法</h2>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;接口幂等性适用场景及设计方法&quot;&gt;&lt;a href=&quot;#接口幂等性适用场景及设计方法&quot; class=&quot;headerlink&quot; title=&quot;接口幂等性适用场景及设计方法&quot;&gt;&lt;/a&gt;接口幂等性适用场景及设计方法&lt;/h2&gt;
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>&#39;mysql查看锁&#39;</title>
    <link href="http://yoursite.com/2019/09/12/mysql%E6%9F%A5%E7%9C%8B%E9%94%81/"/>
    <id>http://yoursite.com/2019/09/12/mysql查看锁/</id>
    <published>2019-09-12T03:26:51.000Z</published>
    <updated>2019-09-12T03:29:56.174Z</updated>
    
    <content type="html"><![CDATA[<h4 id="mysql查看锁-释放锁"><a href="#mysql查看锁-释放锁" class="headerlink" title="mysql查看锁,释放锁"></a>mysql查看锁,释放锁</h4><h2 id="第一种"><a href="#第一种" class="headerlink" title="第一种"></a>第一种</h2><ol><li>查询是否锁表</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show OPEN TABLES where In_use &gt; 0;</span><br></pre></td></tr></table></figure><ol start="2"><li>查询进程（如果您有SUPER权限，您可以看到所有线程。否则，您只能看到您自己的线程）</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show processlist</span><br></pre></td></tr></table></figure><ol start="3"><li>杀死进程id（就是上面命令的id列）<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kill id</span><br></pre></td></tr></table></figure></li></ol><h2 id="第二种"><a href="#第二种" class="headerlink" title="第二种"></a>第二种</h2><ol><li>查看下在锁的事务</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM INFORMATION_SCHEMA.INNODB_TRX;</span><br></pre></td></tr></table></figure><ol start="2"><li>杀死进程id（就是上面命令的trx_mysql_thread_id列）</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kill 线程ID</span><br></pre></td></tr></table></figure><p>例子：</p><p>查出死锁进程：SHOW PROCESSLIST<br>杀掉进程          KILL 420821;</p><p>其它关于查看死锁的命令：</p><ol><li><p>查看当前的事务</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM INFORMATION_SCHEMA.INNODB_TRX;</span><br></pre></td></tr></table></figure></li><li><p>查看当前锁定的事务</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM INFORMATION_SCHEMA.INNODB_LOCKS;</span><br></pre></td></tr></table></figure></li><li><p>查看当前等锁的事务</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM INFORMATION_SCHEMA.INNODB_LOCK_WAITS;</span><br></pre></td></tr></table></figure></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;mysql查看锁-释放锁&quot;&gt;&lt;a href=&quot;#mysql查看锁-释放锁&quot; class=&quot;headerlink&quot; title=&quot;mysql查看锁,释放锁&quot;&gt;&lt;/a&gt;mysql查看锁,释放锁&lt;/h4&gt;&lt;h2 id=&quot;第一种&quot;&gt;&lt;a href=&quot;#第一种&quot; class
      
    
    </summary>
    
    
      <category term="mysql ,锁" scheme="http://yoursite.com/tags/mysql-%E9%94%81/"/>
    
  </entry>
  
  <entry>
    <title>idea_highlight</title>
    <link href="http://yoursite.com/2019/08/08/idea-highlight/"/>
    <id>http://yoursite.com/2019/08/08/idea-highlight/</id>
    <published>2019-08-08T01:45:48.000Z</published>
    <updated>2019-08-08T01:46:36.037Z</updated>
    
    <content type="html"><![CDATA[<h4 id="idea-高亮显示"><a href="#idea-高亮显示" class="headerlink" title="idea 高亮显示"></a>idea 高亮显示</h4><p>依次修改File-settings-Editor-Color Scheme-General菜单下的Code-Identifier under caret和Identifier under caret(write)的Backgroud色值</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;idea-高亮显示&quot;&gt;&lt;a href=&quot;#idea-高亮显示&quot; class=&quot;headerlink&quot; title=&quot;idea 高亮显示&quot;&gt;&lt;/a&gt;idea 高亮显示&lt;/h4&gt;&lt;p&gt;依次修改File-settings-Editor-Color Scheme-Gene
      
    
    </summary>
    
    
      <category term="hightLight" scheme="http://yoursite.com/tags/hightLight/"/>
    
  </entry>
  
  <entry>
    <title>spring_factoryBean</title>
    <link href="http://yoursite.com/2019/07/28/spring-factoryBean/"/>
    <id>http://yoursite.com/2019/07/28/spring-factoryBean/</id>
    <published>2019-07-28T04:20:16.000Z</published>
    <updated>2019-07-28T04:27:02.280Z</updated>
    
    <content type="html"><![CDATA[<h3 id="spring-factoryBean"><a href="#spring-factoryBean" class="headerlink" title="spring factoryBean"></a>spring factoryBean</h3><blockquote><p>Monkey<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">package com.melon.app.bean;</span><br><span class="line">public class Monkey &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p></blockquote><blockquote><p>MelonFactoryBean<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">package com.melon.app.config;</span><br><span class="line"></span><br><span class="line">import com.melon.app.bean.Monkey;</span><br><span class="line">import org.springframework.beans.factory.FactoryBean;</span><br><span class="line"></span><br><span class="line">public class MelonFactoryBean implements FactoryBean&lt;Monkey&gt; &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public Monkey getObject() throws Exception &#123;</span><br><span class="line">        return new Monkey();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Class&lt;?&gt; getObjectType() &#123;</span><br><span class="line">        return Monkey.class;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public boolean isSingleton() &#123;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p></blockquote><p>@Configuration<br>@Import(value = {MelonImportSelector.class,MelonImportBeanDefinitionRegistrar.class})<br>public class MyImportConfigureation {</p><pre><code>@Beanpublic MelonFactoryBean melonFactoryBean(){    return  new MelonFactoryBean();}</code></pre><p>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">````</span><br><span class="line"> ApplicationContext applicationContext = new AnnotationConfigApplicationContext(MyImportConfigureation.class);</span><br><span class="line">    String[] str=  applicationContext.getBeanDefinitionNames();</span><br><span class="line">    Object bean1 = applicationContext.getBean(&quot;melonFactoryBean&quot;);</span><br><span class="line">    System.out.println(bean1.getClass());</span><br></pre></td></tr></table></figure></p><p>结果如下</p><pre><code>class com.melon.app.bean.Monkeyorg.springframework.context.annotation.internalConfigurationAnnotationProcessororg.springframework.context.annotation.internalAutowiredAnnotationProcessororg.springframework.context.annotation.internalCommonAnnotationProcessororg.springframework.context.event.internalEventListenerProcessororg.springframework.context.event.internalEventListenerFactorymyImportConfigureationcom.melon.app.bean.Catcom.melon.app.bean.DogmelonFactoryBeanpig</code></pre>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;spring-factoryBean&quot;&gt;&lt;a href=&quot;#spring-factoryBean&quot; class=&quot;headerlink&quot; title=&quot;spring factoryBean&quot;&gt;&lt;/a&gt;spring factoryBean&lt;/h3&gt;&lt;blockquo
      
    
    </summary>
    
    
      <category term="spring" scheme="http://yoursite.com/tags/spring/"/>
    
  </entry>
  
  <entry>
    <title>spring_import</title>
    <link href="http://yoursite.com/2019/07/28/spring-import/"/>
    <id>http://yoursite.com/2019/07/28/spring-import/</id>
    <published>2019-07-28T03:35:44.000Z</published>
    <updated>2019-07-28T03:59:21.891Z</updated>
    
    <content type="html"><![CDATA[<h2 id="spring-import"><a href="#spring-import" class="headerlink" title="spring import"></a>spring import</h2><h3 id="Import标签使用"><a href="#Import标签使用" class="headerlink" title="@Import标签使用"></a>@Import标签使用</h3><ol><li>一般基本的用import标签使用<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@Import(value = &#123;Dog.class&#125;)</span><br></pre></td></tr></table></figure></li></ol><p>2.实现import接口</p><blockquote><p>Cat<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">package com.melon.app.bean;</span><br><span class="line">public class Cat &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p></blockquote><blockquote><p>Dog<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">package com.melon.app.bean;</span><br><span class="line">public class Dog &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p></blockquote><blockquote><p>MelonImportSelector实现spring提供的接口<br>package com.melon.app.config;</p></blockquote><p>import org.springframework.context.annotation.ImportSelector;<br>import org.springframework.core.type.AnnotationMetadata;</p><p>public class MelonImportSelector implements ImportSelector {<br>    public String[] selectImports(AnnotationMetadata importingClassMetadata) {<br>        return new String[]{“com.melon.app.bean.Cat”,”com.melon.app.bean.Dog”};<br>    }<br>}</p><blockquote><p>MyImportConfigureation 配置类<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">@Import(value = &#123;MelonImportSelector.class&#125;)</span><br><span class="line">public class MyImportConfigureation &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p></blockquote><blockquote><p>测试扫描出来的bean结果如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.context.annotation.internalConfigurationAnnotationProcessor</span><br><span class="line">org.springframework.context.annotation.internalAutowiredAnnotationProcessor</span><br><span class="line">org.springframework.context.annotation.internalCommonAnnotationProcessor</span><br><span class="line">org.springframework.context.event.internalEventListenerProcessor</span><br><span class="line">org.springframework.context.event.internalEventListenerFactory</span><br><span class="line">myImportConfigureation</span><br><span class="line">com.melon.app.bean.Cat</span><br><span class="line">com.melon.app.bean.Dog</span><br></pre></td></tr></table></figure></p></blockquote><ol start="3"><li>importBeanDefintionRegister<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">public class MelonImportBeanDefinitionRegistrar implements ImportBeanDefinitionRegistrar &#123;</span><br><span class="line">    /**</span><br><span class="line">     *</span><br><span class="line">     * @param importingClassMetadata 当前类的注解信息</span><br><span class="line">     * @param registry beanDefinition注册类</span><br><span class="line">     *    把所有需要添加到容器中的bean加入。</span><br><span class="line">     */</span><br><span class="line">    public void registerBeanDefinitions(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry) &#123;</span><br><span class="line">        boolean bean1 = registry.containsBeanDefinition(&quot;com.melon.app.bean.Dog&quot;);</span><br><span class="line">        boolean bean2= registry.containsBeanDefinition(&quot;com.melon.app.bean.Cat&quot;);</span><br><span class="line">        //如果Dog和Cat同时存在于我们IOC容器中，那么创建Pig类，加入到容器</span><br><span class="line">        //对于我们要注册的bean,给bean进行封装，</span><br><span class="line">        if(bean1 &amp;&amp; bean2) &#123;</span><br><span class="line">            RootBeanDefinition beanDefinition = new RootBeanDefinition(Pig.class);</span><br><span class="line">            registry.registerBeanDefinition(&quot;pig&quot;,beanDefinition);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">@Import(value = &#123;MelonImportSelector.class,MelonImportBeanDefinitionRegistrar.class&#125;)</span><br><span class="line">public class MyImportConfigureation &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>扫描注册bean结果<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.context.annotation.internalConfigurationAnnotationProcessor</span><br><span class="line">org.springframework.context.annotation.internalAutowiredAnnotationProcessor</span><br><span class="line">org.springframework.context.annotation.internalCommonAnnotationProcessor</span><br><span class="line">org.springframework.context.event.internalEventListenerProcessor</span><br><span class="line">org.springframework.context.event.internalEventListenerFactory</span><br><span class="line">myImportConfigureation</span><br><span class="line">com.melon.app.bean.Cat</span><br><span class="line">com.melon.app.bean.Dog</span><br><span class="line">pig</span><br></pre></td></tr></table></figure></p></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;spring-import&quot;&gt;&lt;a href=&quot;#spring-import&quot; class=&quot;headerlink&quot; title=&quot;spring import&quot;&gt;&lt;/a&gt;spring import&lt;/h2&gt;&lt;h3 id=&quot;Import标签使用&quot;&gt;&lt;a href=&quot;
      
    
    </summary>
    
    
      <category term="import" scheme="http://yoursite.com/tags/import/"/>
    
  </entry>
  
  <entry>
    <title>spring_basic</title>
    <link href="http://yoursite.com/2019/07/27/spring-basic/"/>
    <id>http://yoursite.com/2019/07/27/spring-basic/</id>
    <published>2019-07-27T13:32:09.000Z</published>
    <updated>2019-07-27T14:04:06.218Z</updated>
    
    <content type="html"><![CDATA[<h3 id="spring基础"><a href="#spring基础" class="headerlink" title="spring基础"></a>spring基础</h3><p>###@Componet####</p><ol><li>@RestController @Service 注解等都是基于@component<br>###@componentScan 源码中的useDefaultFilter####<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">@ComponentScan(value = &quot;com.melon.app&quot;,</span><br><span class="line">        includeFilters =&#123;@ComponentScan.Filter(type =</span><br><span class="line">                FilterType.CUSTOM,classes = &#123;MyTypeFilter.class&#125;)&#125;,</span><br><span class="line">        useDefaultFilters = false)</span><br></pre></td></tr></table></figure></li></ol><p>其中useDefaultFilters为何要设置false的原因就是如果不设置都会扫描@component注解的类<br>源码分析<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">AnnotationConfigApplicationContext-&gt;AbstractApplicationContext.refresh() </span><br><span class="line"></span><br><span class="line">try &#123;</span><br><span class="line">// Allows post-processing of the bean factory in context subclasses.</span><br><span class="line">postProcessBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">// 调用后置拦截器</span><br><span class="line">invokeBeanFactoryPostProcessors(beanFactory);</span><br><span class="line"></span><br><span class="line">// Register bean processors that intercept bean creation.</span><br><span class="line">registerBeanPostProcessors(beanFactory);</span><br><span class="line">````</span><br><span class="line">&gt;AbstractApplicationContextprotected</span><br></pre></td></tr></table></figure></p><p>void invokeBeanFactoryPostProcessors(ConfigurableListableBeanFactory beanFactory)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">//调用后置拦截器</span><br><span class="line">&gt;&gt; PostProcessorRegistrationDelegate</span><br></pre></td></tr></table></figure></p><p>-&gt;invokeBeanFactoryPostProcessors(beanFactory, getBeanFactoryPostProcessors());<br> -&gt;invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry);<br>  -&gt;for (BeanDefinitionRegistryPostProcessor postProcessor : postProcessors) {<br>            postProcessor.postProcessBeanDefinitionRegistry(registry);<br>    }<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; ConfigureClassPostProcessor</span><br></pre></td></tr></table></figure></p><p> -&gt;postProcessBeanDefinitionRegistry<br>  -&gt;processConfigBeanDefinitions<br>    -&gt; parser.parse(candidates);<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; ConfigureClassParser</span><br></pre></td></tr></table></figure></p><p> -&gt;parse(Set<beandefinitionholder> configCandidates)<br>  -&gt;if (bd instanceof AnnotatedBeanDefinition) {<br>      parse(((AnnotatedBeanDefinition) bd).getMetadata(), holder.getBeanName());<br>    }<br>    -&gt;parse(AnnotationMetadata metadata, String beanName)<br>     -&gt;processConfigurationClass(ConfigurationClass configClass)<br>      -&gt; doProcessConfigurationClass(configClass, sourceClass);<br>       -&gt;Set<beandefinitionholder> scannedBeanDefinitions =<br>        this.componentScanParser.parse(componentScan, sourceClass.getMetadata().getClassName());<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; ComponentScanAnnotationParser</span><br></pre></td></tr></table></figure></beandefinitionholder></beandefinitionholder></p><p>   -&gt;parse(AnnotationAttributes componentScan, final String declaringClass)<br>    -&gt;ClassPathBeanDefinitionScanner scanner = new ClassPathBeanDefinitionScanner(this.registry,<br>                componentScan.getBoolean(“useDefaultFilters”), this.environment, this.resourceLoader);<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; ClassPathBeanDefinitionScanner</span><br></pre></td></tr></table></figure></p><p>  -&gt;ClassPathBeanDefinitionScanner(BeanDefinitionRegistry registry, boolean useDefaultFilters,<br>            Environment environment, @Nullable ResourceLoader resourceLoader)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public ClassPathBeanDefinitionScanner(BeanDefinitionRegistry registry, boolean useDefaultFilters,</span><br><span class="line">Environment environment, @Nullable ResourceLoader resourceLoader) &#123;</span><br><span class="line"></span><br><span class="line">Assert.notNull(registry, &quot;BeanDefinitionRegistry must not be null&quot;);</span><br><span class="line">this.registry = registry;</span><br><span class="line"></span><br><span class="line">if (useDefaultFilters) &#123;</span><br><span class="line">registerDefaultFilters();</span><br><span class="line">&#125;</span><br><span class="line">setEnvironment(environment);</span><br><span class="line">setResourceLoader(resourceLoader);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><blockquote><p>ClassPathScanningCandidateComponentProvider<br>····<br>protected void registerDefaultFilters() {<br>       //默认情况下会扫描所有注解是component的类<br>        this.includeFilters.add(new AnnotationTypeFilter(Component.class));<br>        ClassLoader cl = ClassPathScanningCandidateComponentProvider.class.getClassLoader();<br>        try {<br>            this.includeFilters.add(new AnnotationTypeFilter(<br>                    ((Class&lt;? extends Annotation&gt;) ClassUtils.forName(“javax.annotation.ManagedBean”, cl)), false));<br>            logger.trace(“JSR-250 ‘javax.annotation.ManagedBean’ found and supported for component scanning”);<br>        }<br>        catch (ClassNotFoundException ex) {<br>            // JSR-250 1.1 API (as included in Java EE 6) not available - simply skip.<br>        }<br>        try {<br>            this.includeFilters.add(new AnnotationTypeFilter(<br>                    ((Class&lt;? extends Annotation&gt;) ClassUtils.forName(“javax.inject.Named”, cl)), false));<br>            logger.trace(“JSR-330 ‘javax.inject.Named’ annotation found and supported for component scanning”);<br>        }<br>        catch (ClassNotFoundException ex) {<br>            // JSR-330 API not available - simply skip.<br>        }<br>    }<br><code></code>    </p></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;spring基础&quot;&gt;&lt;a href=&quot;#spring基础&quot; class=&quot;headerlink&quot; title=&quot;spring基础&quot;&gt;&lt;/a&gt;spring基础&lt;/h3&gt;&lt;p&gt;###@Componet####&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;@RestController 
      
    
    </summary>
    
    
      <category term="spring基础" scheme="http://yoursite.com/tags/spring%E5%9F%BA%E7%A1%80/"/>
    
  </entry>
  
  <entry>
    <title>springboot_annotation</title>
    <link href="http://yoursite.com/2019/07/20/springboot-annotation/"/>
    <id>http://yoursite.com/2019/07/20/springboot-annotation/</id>
    <published>2019-07-20T13:10:32.000Z</published>
    <updated>2019-07-20T14:07:14.274Z</updated>
    
    <content type="html"><![CDATA[<h3 id="springBoot-Configuration-Lazy"><a href="#springBoot-Configuration-Lazy" class="headerlink" title="springBoot @Configuration  @Lazy"></a>springBoot @Configuration  @Lazy</h3><h4 id="ComponentScan-使用"><a href="#ComponentScan-使用" class="headerlink" title="@ComponentScan 使用"></a>@ComponentScan 使用</h4><p>ComponentScan 就是基本的扫描spring的注解包<br>注意点:如果要用到springboot的Filters属性，那么需要把useDefaultFilters设置成false,否则filter失效<br>@ComponentScan(value=”com.melon.web”,<br>includeFilters={@Filters(type=FilterType.ANNOTATION,classes={Controller.class}},<br>useDefaultFilters=false)</p><p>如果useDefaultFilters不设置false，那么includeFilters就不生效，走的是默认的配置，<br>所以一般情况下你要用到Filter就要设置useDefaultFilters=false<br>FilterType默认按注解过滤</p><ol><li>指定注解类型比如@Controller<blockquote><blockquote><p>@Filters(type=FilterType.ANNOTATION,classes={Controller.class} </p></blockquote></blockquote></li><li>过滤指明具体类<blockquote><blockquote><p>@Filters(type=FilterType.ASSIGNABLE_TYPE,classes={MyController.class}</p></blockquote></blockquote></li><li>自定义类型<blockquote><blockquote><p>@Filters(type=FilterType.CUSTOM,classes={MyFilter.class}</p></blockquote></blockquote></li></ol><blockquote><p>MyFilter 代码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">public class MyTypeFilter implements TypeFilter &#123;</span><br><span class="line">    /**</span><br><span class="line">     *</span><br><span class="line">     * @param metadataReader 读取当前正在扫描类的信息</span><br><span class="line">     * @param metadataReaderFactory 可以获取到其他任何类信息</span><br><span class="line">     * @return</span><br><span class="line">     * @throws IOException</span><br><span class="line">     */</span><br><span class="line"></span><br><span class="line">    public boolean match(MetadataReader metadataReader, MetadataReaderFactory metadataReaderFactory) throws IOException &#123;</span><br><span class="line">        //获取当前类注解的信息</span><br><span class="line">        AnnotationMetadata annotationMetadata = metadataReader.getAnnotationMetadata();</span><br><span class="line">        //获取扫描类的信息</span><br><span class="line">        ClassMetadata classMetadata = metadataReader.getClassMetadata();</span><br><span class="line">        //获取扫描类资源(类路径)</span><br><span class="line">        Resource resource = metadataReader.getResource();</span><br><span class="line">        if(classMetadata.getClassName().contains(&quot;Order&quot;))&#123;</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p></blockquote><h3 id="Lazy"><a href="#Lazy" class="headerlink" title="@Lazy"></a>@Lazy</h3><p>@Lazy主要跟@Bean搭配，专门针对单列bean,容器起来时候不加载,不生成bean<br>等去getBean的时候再去加载，生成bean</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;springBoot-Configuration-Lazy&quot;&gt;&lt;a href=&quot;#springBoot-Configuration-Lazy&quot; class=&quot;headerlink&quot; title=&quot;springBoot @Configuration  @Lazy&quot;&gt;
      
    
    </summary>
    
    
      <category term="springboot" scheme="http://yoursite.com/tags/springboot/"/>
    
  </entry>
  
  <entry>
    <title>python_db</title>
    <link href="http://yoursite.com/2019/04/26/python-db/"/>
    <id>http://yoursite.com/2019/04/26/python-db/</id>
    <published>2019-04-26T09:14:59.000Z</published>
    <updated>2019-04-30T01:42:15.723Z</updated>
    
    <content type="html"><![CDATA[<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">import cx_Oracle</span><br><span class="line">import os</span><br><span class="line">try:</span><br><span class="line">    os.environ[&apos;NLS_LANG&apos;] = &apos;SIMPLIFIED CHINESE_CHINA.utf8&apos;</span><br><span class="line">    db = cx_Oracle.connect(&apos;数据库用户名&apos;, &apos;数据库密码&apos;, &apos;数据库IP地址/数据库实例&apos;)</span><br><span class="line">    c = db.cursor()</span><br><span class="line">    ##读取SQL文件,获得sql语句的list</span><br><span class="line">    with open(u&apos;E:\\test.sql&apos;, &apos;r+&apos;) as f:</span><br><span class="line">        sql_list = f.read().split(&apos;;&apos;)[:-1]  # sql文件最后一行加上;</span><br><span class="line">        sql_list = [x.replace(&apos;\n&apos;, &apos; &apos;) if &apos;\n&apos; in x else x for x in sql_list]  # 将每段sql里的换行符改成空格</span><br><span class="line">    ##执行sql语句，使用循环执行sql语句</span><br><span class="line">    for sql_item  in sql_list:</span><br><span class="line">        # print (sql_item)</span><br><span class="line">        c.execute(sql_item)</span><br><span class="line">except cx_Oracle.Error as e:</span><br><span class="line">    print e</span><br><span class="line">finally:</span><br><span class="line">    c.close()</span><br><span class="line">    db.commit()</span><br><span class="line">    db.close()</span><br></pre></td></tr></table></figure><p>oracle编码问题<br>importlib.reload(sys)<br>os.environ[‘NLS_LANG’] = ‘SIMPLIFIED CHINESE_CHINA.UTF8’</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class
      
    
    </summary>
    
    
      <category term="python" scheme="http://yoursite.com/tags/python/"/>
    
  </entry>
  
  <entry>
    <title>Hello World</title>
    <link href="http://yoursite.com/2019/04/16/hello-world/"/>
    <id>http://yoursite.com/2019/04/16/hello-world/</id>
    <published>2019-04-16T05:55:15.718Z</published>
    <updated>2019-04-16T05:55:15.719Z</updated>
    
    <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="noopener">Deployment</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Welcome to &lt;a href=&quot;https://hexo.io/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Hexo&lt;/a&gt;! This is your very first post. Check &lt;a href=&quot;https://hexo.
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>apollo</title>
    <link href="http://yoursite.com/2019/04/16/apollo/"/>
    <id>http://yoursite.com/2019/04/16/apollo/</id>
    <published>2019-04-16T03:57:23.000Z</published>
    <updated>2019-04-16T03:57:51.963Z</updated>
    
    <content type="html"><![CDATA[<h3 id="apollo"><a href="#apollo" class="headerlink" title="apollo"></a>apollo</h3><p>apollo</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;apollo&quot;&gt;&lt;a href=&quot;#apollo&quot; class=&quot;headerlink&quot; title=&quot;apollo&quot;&gt;&lt;/a&gt;apollo&lt;/h3&gt;&lt;p&gt;apollo&lt;/p&gt;

      
    
    </summary>
    
    
      <category term="apollo" scheme="http://yoursite.com/tags/apollo/"/>
    
  </entry>
  
  <entry>
    <title>jenkins_jacoco</title>
    <link href="http://yoursite.com/2019/01/31/jenkins-jacoco/"/>
    <id>http://yoursite.com/2019/01/31/jenkins-jacoco/</id>
    <published>2019-01-31T01:49:42.000Z</published>
    <updated>2019-01-31T01:50:43.466Z</updated>
    
    <content type="html"><![CDATA[<h4 id="jekins-jacoco"><a href="#jekins-jacoco" class="headerlink" title="jekins jacoco"></a>jekins jacoco</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line"></span><br><span class="line">&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">  xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">  &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span><br><span class="line"></span><br><span class="line">  &lt;groupId&gt;com.melon&lt;/groupId&gt;</span><br><span class="line">  &lt;artifactId&gt;fenmi&lt;/artifactId&gt;</span><br><span class="line">  &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;</span><br><span class="line"></span><br><span class="line">  &lt;name&gt;fenmi&lt;/name&gt;</span><br><span class="line">  &lt;!-- FIXME change it to the project&apos;s website --&gt;</span><br><span class="line">  &lt;url&gt;http://www.example.com&lt;/url&gt;</span><br><span class="line"></span><br><span class="line">  &lt;properties&gt;</span><br><span class="line">    &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;</span><br><span class="line">    &lt;maven.compiler.source&gt;1.7&lt;/maven.compiler.source&gt;</span><br><span class="line">    &lt;maven.compiler.target&gt;1.7&lt;/maven.compiler.target&gt;</span><br><span class="line">  &lt;/properties&gt;</span><br><span class="line"></span><br><span class="line">  &lt;dependencies&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">      &lt;groupId&gt;junit&lt;/groupId&gt;</span><br><span class="line">      &lt;artifactId&gt;junit&lt;/artifactId&gt;</span><br><span class="line">      &lt;version&gt;4.11&lt;/version&gt;</span><br><span class="line">      &lt;scope&gt;test&lt;/scope&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">      &lt;groupId&gt;org.jacoco&lt;/groupId&gt;</span><br><span class="line">      &lt;artifactId&gt;jacoco-maven-plugin&lt;/artifactId&gt;</span><br><span class="line">      &lt;version&gt;0.8.1&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">  &lt;/dependencies&gt;</span><br><span class="line">  &lt;build&gt;</span><br><span class="line">    &lt;plugins&gt;</span><br><span class="line">      &lt;!-- jacoco plugin --&gt;</span><br><span class="line">      &lt;plugin&gt;</span><br><span class="line">        &lt;groupId&gt;org.jacoco&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;jacoco-maven-plugin&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;0.7.9&lt;/version&gt;</span><br><span class="line">        &lt;executions&gt;</span><br><span class="line">          &lt;execution&gt;</span><br><span class="line">            &lt;!-- 在maven的initialize阶段，将Jacoco的runtime agent作为VM的一个参数 传给被测程序，用于监控JVM中的调用。 --&gt;</span><br><span class="line">            &lt;id&gt;default-prepare-agent&lt;/id&gt;</span><br><span class="line">            &lt;goals&gt;</span><br><span class="line">              &lt;goal&gt;prepare-agent&lt;/goal&gt;</span><br><span class="line">            &lt;/goals&gt;</span><br><span class="line">            &lt;configuration&gt;</span><br><span class="line">              &lt;destFile&gt;</span><br><span class="line">                $&#123;project.build.directory&#125;/coverage-reports/jacoco.exec</span><br><span class="line">              &lt;/destFile&gt;</span><br><span class="line">              &lt;propertyName&gt;surefireArgLine&lt;/propertyName&gt;</span><br><span class="line">            &lt;/configuration&gt;</span><br><span class="line">          &lt;/execution&gt;</span><br><span class="line">          &lt;!-- 在程序的verify阶段，执行report测试的程序。 文件的输入为perpare-agent阶段中设置或者默认的jacoco.exec.</span><br><span class="line">              参数 includes和excludes可用来选定report中过滤的类。 --&gt;</span><br><span class="line">          &lt;execution&gt;</span><br><span class="line">            &lt;id&gt;default-report&lt;/id&gt;</span><br><span class="line">            &lt;phase&gt;test&lt;/phase&gt;</span><br><span class="line">            &lt;goals&gt;</span><br><span class="line">              &lt;goal&gt;report&lt;/goal&gt;</span><br><span class="line">            &lt;/goals&gt;</span><br><span class="line">            &lt;configuration&gt;</span><br><span class="line">              &lt;dataFile&gt;$&#123;project.build.directory&#125;/coverage-reports/jacoco.exec&lt;/dataFile&gt;</span><br><span class="line">              &lt;outputDirectory&gt;$&#123;project.reporting.outputDirectory&#125;/jacoco&lt;/outputDirectory&gt;</span><br><span class="line">            &lt;/configuration&gt;</span><br><span class="line">          &lt;/execution&gt;</span><br><span class="line">        &lt;/executions&gt;</span><br><span class="line">      &lt;/plugin&gt;</span><br><span class="line">      &lt;!-- 使用 maven-surefire-plugin来执行单元测试。 将surefireArgLine赋值给argLine参数，以保证在测试执行时Jacoco</span><br><span class="line">          agent处于运行状态。 --&gt;</span><br><span class="line">      &lt;plugin&gt;</span><br><span class="line">        &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;maven-surefire-plugin&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;2.19.1&lt;/version&gt;</span><br><span class="line">        &lt;configuration&gt;</span><br><span class="line">          &lt;argLine&gt;$&#123;surefireArgLine&#125;&lt;/argLine&gt;</span><br><span class="line">        &lt;/configuration&gt;</span><br><span class="line">      &lt;/plugin&gt;</span><br><span class="line">    &lt;/plugins&gt;</span><br><span class="line">  &lt;/build&gt;</span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;jekins-jacoco&quot;&gt;&lt;a href=&quot;#jekins-jacoco&quot; class=&quot;headerlink&quot; title=&quot;jekins jacoco&quot;&gt;&lt;/a&gt;jekins jacoco&lt;/h4&gt;&lt;figure class=&quot;highlight plai
      
    
    </summary>
    
    
      <category term="jenkins" scheme="http://yoursite.com/tags/jenkins/"/>
    
  </entry>
  
  <entry>
    <title>docker_jenkins</title>
    <link href="http://yoursite.com/2019/01/29/docker-jenkins/"/>
    <id>http://yoursite.com/2019/01/29/docker-jenkins/</id>
    <published>2019-01-29T02:10:20.000Z</published>
    <updated>2019-01-29T08:01:23.003Z</updated>
    
    <content type="html"><![CDATA[<h4 id="docker-jenkins"><a href="#docker-jenkins" class="headerlink" title="docker jenkins"></a>docker jenkins</h4><h5 id="1拉取镜像"><a href="#1拉取镜像" class="headerlink" title="1拉取镜像"></a>1拉取镜像</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull jenkinsci/jenkins</span><br></pre></td></tr></table></figure><h5 id="2根据镜像启动容器"><a href="#2根据镜像启动容器" class="headerlink" title="2根据镜像启动容器"></a>2根据镜像启动容器</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 8080:8080 -p 50000:50000 jenkinsci/jenkins</span><br></pre></td></tr></table></figure><h5 id="3根据提示去查需要初始的密码"><a href="#3根据提示去查需要初始的密码" class="headerlink" title="3根据提示去查需要初始的密码"></a>3根据提示去查需要初始的密码</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it 015fad435af29056b08298af455c9dba0f1289be5e03588022736018a1610d70 bash </span><br><span class="line">cat /var/jenkins_home/secrets/initialAdminPassword</span><br></pre></td></tr></table></figure><h5 id="4根据界面提示去安装插件"><a href="#4根据界面提示去安装插件" class="headerlink" title="4根据界面提示去安装插件"></a>4根据界面提示去安装插件</h5><h5 id="5安装ssh-key连接gitLab"><a href="#5安装ssh-key连接gitLab" class="headerlink" title="5安装ssh key连接gitLab"></a>5安装ssh key连接gitLab</h5><p>这个时候要注意，</p><ol><li>配置的公钥私钥来自于jenkins服务器,注意用jenkins<br>账户生成公钥私钥。</li><li>在gitLab的deploy key里配置公钥</li><li>在jenkins凭据里配置私钥</li><li>然后在jenkins服务器上git clone 下地址，用来测试是不是可以连接到gitLab.<br>如果可以证明配置成功。</li></ol><p>gitLab</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;docker-jenkins&quot;&gt;&lt;a href=&quot;#docker-jenkins&quot; class=&quot;headerlink&quot; title=&quot;docker jenkins&quot;&gt;&lt;/a&gt;docker jenkins&lt;/h4&gt;&lt;h5 id=&quot;1拉取镜像&quot;&gt;&lt;a href=&quot;#
      
    
    </summary>
    
    
      <category term="docker jenkins" scheme="http://yoursite.com/tags/docker-jenkins/"/>
    
  </entry>
  
  <entry>
    <title>docker example</title>
    <link href="http://yoursite.com/2019/01/25/docker-example/"/>
    <id>http://yoursite.com/2019/01/25/docker-example/</id>
    <published>2019-01-25T07:51:26.000Z</published>
    <updated>2019-01-25T09:04:31.167Z</updated>
    
    <content type="html"><![CDATA[<h4 id="docker-example"><a href="#docker-example" class="headerlink" title="docker example"></a>docker example</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ tree identidock/</span><br><span class="line">identidock/</span><br><span class="line">└─ app</span><br><span class="line"> └─ identidock.py</span><br></pre></td></tr></table></figure><p>identidock.py<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">from flask import Flask</span><br><span class="line">app = Flask(__name__) </span><br><span class="line">@app.route(&apos;/&apos;) </span><br><span class="line">def hello_world():</span><br><span class="line"> return &apos;Hello World!\n&apos;</span><br><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line"> app.run(debug=True, host=&apos;0.0.0.0&apos;)</span><br></pre></td></tr></table></figure></p><p>在 identidock 目录下，创建一个名为<br>Dockerfile 的文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">FROM python:3.4</span><br><span class="line">RUN pip install Flask==0.10.1</span><br><span class="line">WORKDIR /app</span><br><span class="line">COPY app /app</span><br><span class="line">CMD [&quot;python&quot;, &quot;identidock.py&quot;]</span><br></pre></td></tr></table></figure></p><p>现在，可以构建和运行我们的简单应用了：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ cd identidock</span><br><span class="line">$ docker build -t identidock .</span><br><span class="line">...</span><br><span class="line">$ docker run -d -p 5000:5000 identidock</span><br><span class="line">0c75444e8f5f16dfe5aceb0aae074cc33dfc06f2d2fb6adb773ac51f20605aa4</span><br></pre></td></tr></table></figure></p><blockquote><p>我把 -d 选项传给 docker run，让它在后台启动容器，但如果想看到 Web 服务器<br>的输出，也可以把它省略。-p 5000:5000 参数告诉 Docker，我们要将容器的 5000 端口转发<br>到主机上的 5000 端口。</p></blockquote><p>test<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ curl localhost:5000</span><br><span class="line">Hello World!</span><br></pre></td></tr></table></figure></p><blockquote><p>目前这个工作流程有一个比较严重的问题：即使代码只有少许改变，我们<br>也需要重新创建镜像，并且重启容器。幸好，有一个简单的解决方法。我们可以把主机上<br>的源码目录绑定挂载（bind mount）到容器内的源码目录之上。</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 5000:5000 -v &quot;$PWD&quot;/app:/app identidock</span><br></pre></td></tr></table></figure><p>-v “$PWD”/app:/app 参数把位于 /app 的 app 目录挂载到容器内。它将覆盖容器中 /app 目录<br>的内容 ，而且在容器内还可以进行读写（如果你不希望这样，也可以把数据卷挂载为只<br>读）。参数 -v 必须是绝对路径，因此在这个例子中，我们在当前的目录前加上 $PWD，</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;docker-example&quot;&gt;&lt;a href=&quot;#docker-example&quot; class=&quot;headerlink&quot; title=&quot;docker example&quot;&gt;&lt;/a&gt;docker example&lt;/h4&gt;&lt;figure class=&quot;highlight 
      
    
    </summary>
    
    
      <category term="docker" scheme="http://yoursite.com/tags/docker/"/>
    
  </entry>
  
  <entry>
    <title>docker常用命令</title>
    <link href="http://yoursite.com/2019/01/25/docker%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/"/>
    <id>http://yoursite.com/2019/01/25/docker常用命令/</id>
    <published>2019-01-25T07:11:13.000Z</published>
    <updated>2019-01-25T07:20:05.526Z</updated>
    
    <content type="html"><![CDATA[<h3 id="docker常用命令-RUN命令"><a href="#docker常用命令-RUN命令" class="headerlink" title="docker常用命令_RUN命令"></a>docker常用命令_RUN命令</h3><blockquote><p>启动新容器时必然会用到它。因此，它是迄<br>今为止最复杂的命令，能支持非常多的参数。它的选项允许用户配置镜像运行的方式、覆<br>盖 Dockerfile 设置、配置联网，以及设置容器的权限和资源。</p></blockquote><table><thead><tr><th>命令</th><th style="text-align:center">描述</th></tr></thead><tbody><tr><td>-a, –attach</td><td style="text-align:center">把指定的数据流（如 STDOUT 之类）连接至终端。若未指定，则默认连接 stdout 和</td></tr></tbody></table><p>stderr。若数据流未指定，而容器以交互模式（-i）启动，则 stdin 也会被连接至终端。<br>此选项与 -d 选项不兼容<br>-d, –detach|使容器在“分离”模式下运行。容器会在后台运行，而命令的返回值是容器的 ID。<br>-i, –interactive|保持 stdin 打开（即使它没有被被连接至终端 10）。一般与 –t 同时使用，用作启动交互<br>式会话的容器。例如：<br>$ docker run -it debian /bin/bash<br>root@bd0f26f928bb:/# ls<br>…省略…</p><p>–restart|配置 Docker 在什么情况下尝试重新启动已退出的容器。参数为 no 意味着永远不会尝<br>试重新启动容器；always 指不管退出状态是什么，总会尝试重新启动；on-failure 仅<br>当退出状态不为 0 的时候才会尝试重启 ，并且可以追加一个可选参数，指定尝试重启<br>的次数，超过重启次数就会放弃（如果没有指定，那就一直重试）。例如，docker run<br>–restart on-failure:10 postgres 将启动 postgres 容器，并当退出值不为 0 的时候，<br>尝试重启最多 10 次。<br>–rm|退出时自动删除容器。不能与 -d 选项同时使用。<br>-t, –tty|分配一个伪终端（pseudo-TTY）。通常与 -i 同时使用，用来启动交互式容器。<br>-e, –env|设置容器内的环境变量。例如：<br>$ docker run -e var1=val -e var2=”val 2” debian env<br>PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin<br>HOSTNAME=b15f833d65d8<br>var1=val<br>var2=val 2<br>HOME=/root<br>另外，–env-file 选项可以经文件传入环境变量。<br>-h, –hostname NAME|设置容器的 unix 主机名为 NAME。例如：<br>$ docker run -h “myhost” debian hostname<br>myhost<br>–name NAME|把 NAME 设置为容器的名称。以后，其他 Docker 命令便可以使用该名称来称呼这个容器。<br>以下选项允许用户进行数据卷的设置<br>-v, –volume|这个选项可以用来设置数据卷（数据卷即一个容器中的文件或目录，实际属于主机的文<br>件系统，而非容器的联合文件系统的一部分），有两种形式的参数可供使用。第一种形<br>式仅指定容器中的目录，Docker 会自行选定一个主机上的目录与之绑定。第二种形式<br>除了指定容器目录，还指定与容器目录绑定的主机目录。<br>–volumes-from|挂载指定容器拥有的数据卷。经常用于数据容器<br>–expose|与 Dockerfile 的 EXPOSE 指令功能一样。指定容器将会使用的端口或端口范围，但并不会<br>把端口打开。只有与 -P 参数同时使用，以及在连接容器时，才有真正意义。<br>–link|建立一个与指定容器连接的内部网络接口。详<br>-p, –publish|“发布”容器的端口，使主机能访问它。若没有指定主机端口，则会随机分配一个高端<br>口，可通过 docker port 命令查看分配了哪个端口。还可以指定端口是在主机的哪个网<br>络接口开放。<br>-P, –publish-all|“发布”所有已指定为开放（exposed）的容器端口，使主机能访问它们。每个容器端口<br>均对应一个随机挑选的高端口。docker port 命令可以用来查看端口之间的映射关系。<br>如果你需要更高级的联网功能，还有几个进阶的选项可用。但请注意，这些选项中有一些<br>要求你对联网有一定了解，以及明白联网在 Docker 中如何实现</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;docker常用命令-RUN命令&quot;&gt;&lt;a href=&quot;#docker常用命令-RUN命令&quot; class=&quot;headerlink&quot; title=&quot;docker常用命令_RUN命令&quot;&gt;&lt;/a&gt;docker常用命令_RUN命令&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt;启
      
    
    </summary>
    
    
      <category term="docker" scheme="http://yoursite.com/tags/docker/"/>
    
  </entry>
  
  <entry>
    <title>gitlab备份还原</title>
    <link href="http://yoursite.com/2019/01/23/gitlab%E5%A4%87%E4%BB%BD%E8%BF%98%E5%8E%9F/"/>
    <id>http://yoursite.com/2019/01/23/gitlab备份还原/</id>
    <published>2019-01-23T02:48:49.000Z</published>
    <updated>2019-01-24T08:14:51.986Z</updated>
    
    <content type="html"><![CDATA[<h3 id="备份跟还原-GitLab"><a href="#备份跟还原-GitLab" class="headerlink" title="备份跟还原 GitLab"></a>备份跟还原 GitLab</h3><p>应用数据备份创建的压缩文件包含了数据库，所有代码仓库和所有附件。<br>你可以在另一个利用同一个版本的gitLab中回复。<br>通过备份跟恢复是迁移你的仓库从一个服务器到另一个的最好的方式。</p><h4 id="需要条件"><a href="#需要条件" class="headerlink" title="需要条件"></a>需要条件</h4><p>为了能够备份跟恢复，你需要在你的系统中安装2个必要的工具。</p><h5 id="Rsync-远程同步工具"><a href="#Rsync-远程同步工具" class="headerlink" title="Rsync(远程同步工具)"></a>Rsync(远程同步工具)</h5><p>如果你已经安装了GitLab:<br> 利用OmniBus包<br> 确保rsync都安装</p> <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># Debian/Ubuntu</span><br><span class="line">sudo apt-get install rsync</span><br><span class="line"># RHEL/CentOS</span><br><span class="line">sudo yum install rsync</span><br></pre></td></tr></table></figure><h5 id="Tar"><a href="#Tar" class="headerlink" title="Tar"></a>Tar</h5><p>确保Tar命令在1.3.0以上<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar --version</span><br></pre></td></tr></table></figure></p><h5 id="备份timestamp"><a href="#备份timestamp" class="headerlink" title="备份timestamp"></a>备份timestamp</h5><blockquote><p>在 GitLab 9.2 the timestamp 格式变了从<br>EPOCH_YYYY_MM_DD 到 EPOCH_YYYY_MM_DD_GitLab_version,<br>比如 1493107454_2018_04_25 会变成 1493107454_2018_04_25_10.6.4-ce.</p></blockquote><h5 id="Gitlab的备份目录路径设置"><a href="#Gitlab的备份目录路径设置" class="headerlink" title="Gitlab的备份目录路径设置"></a>Gitlab的备份目录路径设置</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@code-server ~]# vim /etc/gitlab/gitlab.rb</span><br><span class="line">gitlab_rails[&apos;manage_backup_path&apos;] = true</span><br><span class="line">gitlab_rails[&apos;backup_path&apos;] = &quot;/data/gitlab/backups&quot;    //gitlab备份目录</span><br><span class="line">gitlab_rails[&apos;backup_archive_permissions&apos;] = 0644       //生成的备份文件权限</span><br><span class="line">gitlab_rails[&apos;backup_keep_time&apos;] = 7776000              //备份保留天数为3个月（即90天，这里是7776000秒）</span><br><span class="line"> </span><br><span class="line">[root@code-server ~]# mkdir -p /data/gitlab/backups</span><br><span class="line">[root@code-server ~]# chown -R git.git /data/gitlab/backups</span><br><span class="line">[root@code-server ~]# chmod -R 777 /data/gitlab/backups</span><br><span class="line">  </span><br><span class="line">如上设置了gitlab备份目录路径为/data/gitlab/backups，最后使用下面命令重载gitlab配置文件，是上述修改生效！</span><br><span class="line">root@code-server ~]# gitlab-ctl reconfigure</span><br></pre></td></tr></table></figure><h5 id="GItlab备份操作（使用备份命令”gitlab-rake-gitlab-backup-create”）"><a href="#GItlab备份操作（使用备份命令”gitlab-rake-gitlab-backup-create”）" class="headerlink" title="GItlab备份操作（使用备份命令”gitlab-rake gitlab:backup:create”）"></a>GItlab备份操作（使用备份命令”gitlab-rake gitlab:backup:create”）</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">手动备份gitlab</span><br><span class="line">[root@code-server backups]# gitlab-rake gitlab:backup:create</span><br><span class="line">Dumping database ...</span><br><span class="line">Dumping PostgreSQL database gitlabhq_production ... [DONE]</span><br><span class="line">done</span><br><span class="line">Dumping repositories ...</span><br><span class="line"> * treesign/treesign ... [DONE]</span><br><span class="line"> * gateway/gateway ... [DONE]</span><br><span class="line"> * treesign/treesign-doc ... [SKIPPED]</span><br><span class="line"> * qwsign/qwsign ... [DONE]</span><br><span class="line"> * qwsign/qwsign-doc ... [DONE]</span><br><span class="line"> * test/test ... [DONE]</span><br><span class="line">done</span><br><span class="line">Dumping uploads ...</span><br><span class="line">done</span><br><span class="line">Dumping builds ...</span><br><span class="line">done</span><br><span class="line">Dumping artifacts ...</span><br><span class="line">done</span><br><span class="line">Dumping pages ...</span><br><span class="line">done</span><br><span class="line">Dumping lfs objects ...</span><br><span class="line">done</span><br><span class="line">Dumping container registry images ...</span><br><span class="line">[DISABLED]</span><br><span class="line">Creating backup archive: 1510471890_2017_11_12_9.4.5_gitlab_backup.tar ... done</span><br><span class="line">Uploading backup archive to remote storage  ... skipped</span><br><span class="line">Deleting tmp directories ... done</span><br><span class="line">done</span><br><span class="line">done</span><br><span class="line">done</span><br><span class="line">done</span><br><span class="line">done</span><br><span class="line">done</span><br><span class="line">done</span><br><span class="line">Deleting old backups ... done. (0 removed)</span><br><span class="line"> </span><br><span class="line">然后查看下备份文件（文件权限是设定好的644）</span><br><span class="line">[root@code-server backups]# ll</span><br><span class="line">total 244</span><br><span class="line">-rw-r--r-- 1 git git 245760 Nov 12 15:33 1510472027_2017_11_12_9.4.5_gitlab_backup.tar</span><br><span class="line"> </span><br><span class="line">编写备份脚本，结合crontab实施自动定时备份，比如每天0点、6点、12点、18点各备份一次</span><br><span class="line">[root@code-server backups]# pwd</span><br><span class="line">/data/gitlab/backups</span><br><span class="line">[root@code-server backups]# vim gitlab_backup.sh</span><br><span class="line">#!/bin/bash</span><br><span class="line">/usr/bin/gitlab-rake gitlab:backup:create CRON=1</span><br><span class="line"> </span><br><span class="line">注意：环境变量CRON=1的作用是如果没有任何错误发生时， 抑制备份脚本的所有进度输出</span><br><span class="line"> </span><br><span class="line">[root@code-server backups]# crontab -l</span><br><span class="line">0 0,6,12,18 * * * /bin/bash -x /data/gitlab/backups/gitlab_backup.sh &gt; /dev/null 2&gt;&amp;1</span><br></pre></td></tr></table></figure><h5 id="Gitlab恢复操作"><a href="#Gitlab恢复操作" class="headerlink" title="Gitlab恢复操作"></a>Gitlab恢复操作</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br></pre></td><td class="code"><pre><span class="line">GItlab只能还原到与备份文件相同的gitlab版本。</span><br><span class="line">假设在上面gitlab备份之前创建了test项目，然后不小心误删了test项目，现在就进行gitlab恢复操作：</span><br><span class="line">  </span><br><span class="line">1）停止相关数据连接服务</span><br><span class="line">[root@code-server backups]# gitlab-ctl stop unicorn</span><br><span class="line">ok: down: unicorn: 0s, normally up</span><br><span class="line">[root@code-server backups]# gitlab-ctl stop sidekiq</span><br><span class="line">ok: down: sidekiq: 1s, normally up</span><br><span class="line">[root@code-server backups]# gitlab-ctl status</span><br><span class="line">run: gitaly: (pid 98087) 1883s; run: log: (pid 194202) 163003s</span><br><span class="line">run: gitlab-monitor: (pid 98101) 1883s; run: log: (pid 194363) 163002s</span><br><span class="line">run: gitlab-workhorse: (pid 98104) 1882s; run: log: (pid 194362) 163002s</span><br><span class="line">run: logrotate: (pid 98117) 1882s; run: log: (pid 5793) 160832s</span><br><span class="line">run: nginx: (pid 98123) 1881s; run: log: (pid 194359) 163002s</span><br><span class="line">run: node-exporter: (pid 98167) 1881s; run: log: (pid 194360) 163002s</span><br><span class="line">run: postgres-exporter: (pid 98173) 1881s; run: log: (pid 194204) 163003s</span><br><span class="line">run: postgresql: (pid 98179) 1880s; run: log: (pid 194365) 163002s</span><br><span class="line">run: prometheus: (pid 98187) 1880s; run: log: (pid 194364) 163002s</span><br><span class="line">run: redis: (pid 98230) 1879s; run: log: (pid 194358) 163002s</span><br><span class="line">run: redis-exporter: (pid 98234) 1879s; run: log: (pid 194208) 163003s</span><br><span class="line">down: sidekiq: 8s, normally up; run: log: (pid 194437) 163001s</span><br><span class="line">down: unicorn: 21s, normally up; run: log: (pid 194443) 163001s</span><br><span class="line">  </span><br><span class="line">2）现在通过之前的备份文件进行恢复（必须要备份文件放到备份路径下，这里备份路径我自定义的/data/gitlab/backups，默认的是/var/opt/gitlab/backups）</span><br><span class="line">[root@code-server backups]# pwd</span><br><span class="line">/data/gitlab/backups</span><br><span class="line">[root@code-server backups]# ll</span><br><span class="line">total 244</span><br><span class="line">-rw-r--r-- 1 git git 245760 Nov 12 15:33 1510472027_2017_11_12_9.4.5_gitlab_backup.tar</span><br><span class="line">  </span><br><span class="line">Gitlab的恢复操作会先将当前所有的数据清空，然后再根据备份数据进行恢复</span><br><span class="line">[root@code-server backups]# gitlab-rake gitlab:backup:restore BACKUP=1510472027_2017_11_12_9.4.5</span><br><span class="line">Unpacking backup ... done</span><br><span class="line">Before restoring the database we recommend removing all existing</span><br><span class="line">tables to avoid future upgrade problems. Be aware that if you have</span><br><span class="line">custom tables in the GitLab database these tables and all data will be</span><br><span class="line">removed.</span><br><span class="line">  </span><br><span class="line">Do you want to continue (yes/no)?</span><br><span class="line">........</span><br><span class="line">ALTER TABLE</span><br><span class="line">ALTER TABLE</span><br><span class="line">ALTER TABLE</span><br><span class="line">ALTER TABLE</span><br><span class="line">WARNING:  no privileges were granted for &quot;public&quot;</span><br><span class="line">GRANT</span><br><span class="line">[DONE]</span><br><span class="line">done</span><br><span class="line">Restoring repositories ...</span><br><span class="line"> * treesign/treesign ... [DONE]</span><br><span class="line"> * gateway/gateway ... [DONE]</span><br><span class="line"> * treesign/treesign-doc ... [DONE]</span><br><span class="line"> * qwsign/qwsign ... [DONE]</span><br><span class="line"> * qwsign/qwsign-doc ... [DONE]</span><br><span class="line"> * test/test ... [DONE]</span><br><span class="line">Put GitLab hooks in repositories dirs [DONE]</span><br><span class="line">done</span><br><span class="line">Restoring uploads ...</span><br><span class="line">done</span><br><span class="line">Restoring builds ...</span><br><span class="line">done</span><br><span class="line">Restoring artifacts ...</span><br><span class="line">done</span><br><span class="line">Restoring pages ...</span><br><span class="line">done</span><br><span class="line">Restoring lfs objects ...</span><br><span class="line">done</span><br><span class="line">This will rebuild an authorized_keys file.</span><br><span class="line">You will lose any data stored in authorized_keys file.</span><br><span class="line">Do you want to continue (yes/no)? yes</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">Deleting tmp directories ... done</span><br><span class="line">done</span><br><span class="line">done</span><br><span class="line">done</span><br><span class="line">done</span><br><span class="line">done</span><br><span class="line">done</span><br><span class="line">done</span><br><span class="line">[root@code-server backups]#</span><br><span class="line">  </span><br><span class="line">最后再次启动Gitlab</span><br><span class="line">[root@code-server backups]# gitlab-ctl start</span><br><span class="line">ok: run: gitaly: (pid 98087) 2138s</span><br><span class="line">ok: run: gitlab-monitor: (pid 98101) 2138s</span><br><span class="line">ok: run: gitlab-workhorse: (pid 98104) 2137s</span><br><span class="line">ok: run: logrotate: (pid 98117) 2137s</span><br><span class="line">ok: run: nginx: (pid 98123) 2136s</span><br><span class="line">ok: run: node-exporter: (pid 98167) 2136s</span><br><span class="line">ok: run: postgres-exporter: (pid 98173) 2136s</span><br><span class="line">ok: run: postgresql: (pid 98179) 2135s</span><br><span class="line">ok: run: prometheus: (pid 98187) 2135s</span><br><span class="line">ok: run: redis: (pid 98230) 2134s</span><br><span class="line">ok: run: redis-exporter: (pid 98234) 2134s</span><br><span class="line">ok: run: sidekiq: (pid 104494) 0s</span><br><span class="line">ok: run: unicorn: (pid 104497) 1s</span><br><span class="line">[root@code-server backups]# gitlab-ctl status</span><br><span class="line">run: gitaly: (pid 98087) 2142s; run: log: (pid 194202) 163262s</span><br><span class="line">run: gitlab-monitor: (pid 98101) 2142s; run: log: (pid 194363) 163261s</span><br><span class="line">run: gitlab-workhorse: (pid 98104) 2141s; run: log: (pid 194362) 163261s</span><br><span class="line">run: logrotate: (pid 98117) 2141s; run: log: (pid 5793) 161091s</span><br><span class="line">run: nginx: (pid 98123) 2140s; run: log: (pid 194359) 163261s</span><br><span class="line">run: node-exporter: (pid 98167) 2140s; run: log: (pid 194360) 163261s</span><br><span class="line">run: postgres-exporter: (pid 98173) 2140s; run: log: (pid 194204) 163262s</span><br><span class="line">run: postgresql: (pid 98179) 2139s; run: log: (pid 194365) 163261s</span><br><span class="line">run: prometheus: (pid 98187) 2139s; run: log: (pid 194364) 163261s</span><br><span class="line">run: redis: (pid 98230) 2138s; run: log: (pid 194358) 163261s</span><br><span class="line">run: redis-exporter: (pid 98234) 2138s; run: log: (pid 194208) 163262s</span><br><span class="line">run: sidekiq: (pid 104494) 4s; run: log: (pid 194437) 163260s</span><br><span class="line">run: unicorn: (pid 104497) 4s; run: log: (pid 194443) 163260s</span><br><span class="line"> </span><br><span class="line">恢复命令完成后，可以check检查一下恢复情况</span><br><span class="line">[root@code-server backups]# gitlab-rake gitlab:check SANITIZE=true</span><br><span class="line">Checking GitLab Shell ...</span><br><span class="line"> </span><br><span class="line">GitLab Shell version &gt;= 5.3.1 ? ... OK (5.3.1)</span><br><span class="line">Repo base directory exists?</span><br><span class="line">default... yes</span><br><span class="line">Repo storage directories are symlinks?</span><br><span class="line">default... no</span><br><span class="line">Repo paths owned by git:root, or git:git?</span><br><span class="line">default... yes</span><br><span class="line">Repo paths access is drwxrws---?</span><br><span class="line">default... yes</span><br><span class="line">hooks directories in repos are links: ...</span><br><span class="line">5/1 ... ok</span><br><span class="line">6/2 ... ok</span><br><span class="line">5/3 ... repository is empty</span><br><span class="line">12/4 ... ok</span><br><span class="line">12/5 ... ok</span><br><span class="line">Running /opt/gitlab/embedded/service/gitlab-shell/bin/check</span><br><span class="line">Check GitLab API access: OK</span><br><span class="line">Access to /var/opt/gitlab/.ssh/authorized_keys: OK</span><br><span class="line">Send ping to redis server: OK</span><br><span class="line">gitlab-shell self-check successful</span><br><span class="line"> </span><br><span class="line">Checking GitLab Shell ... Finished</span><br><span class="line"> </span><br><span class="line">Checking Sidekiq ...</span><br><span class="line"> </span><br><span class="line">Running? ... yes</span><br><span class="line">Number of Sidekiq processes ... 1</span><br><span class="line"> </span><br><span class="line">Checking Sidekiq ... Finished</span><br><span class="line"> </span><br><span class="line">Checking Reply by email ...</span><br><span class="line"> </span><br><span class="line">Reply by email is disabled in config/gitlab.yml</span><br><span class="line"> </span><br><span class="line">Checking Reply by email ... Finished</span><br><span class="line"> </span><br><span class="line">Checking LDAP ...</span><br><span class="line"> </span><br><span class="line">LDAP is disabled in config/gitlab.yml</span><br><span class="line"> </span><br><span class="line">Checking LDAP ... Finished</span><br><span class="line"> </span><br><span class="line">Checking GitLab ...</span><br><span class="line"> </span><br><span class="line">Git configured correctly? ... yes</span><br><span class="line">Database config exists? ... yes</span><br><span class="line">All migrations up? ... yes</span><br><span class="line">Database contains orphaned GroupMembers? ... no</span><br><span class="line">GitLab config exists? ... yes</span><br><span class="line">GitLab config up to date? ... yes</span><br><span class="line">Log directory writable? ... yes</span><br><span class="line">Tmp directory writable? ... yes</span><br><span class="line">Uploads directory exists? ... yes</span><br><span class="line">Uploads directory has correct permissions? ... yes</span><br><span class="line">Uploads directory tmp has correct permissions? ... yes</span><br><span class="line">Init script exists? ... skipped (omnibus-gitlab has no init script)</span><br><span class="line">Init script up-to-date? ... skipped (omnibus-gitlab has no init script)</span><br><span class="line">Projects have namespace: ...</span><br><span class="line">5/1 ... yes</span><br><span class="line">6/2 ... yes</span><br><span class="line">5/3 ... yes</span><br><span class="line">12/4 ... yes</span><br><span class="line">12/5 ... yes</span><br><span class="line">Redis version &gt;= 2.8.0? ... yes</span><br><span class="line">Ruby version &gt;= 2.3.3 ? ... yes (2.3.3)</span><br><span class="line">Git version &gt;= 2.7.3 ? ... yes (2.13.4)</span><br><span class="line">Active users: ... 11</span><br><span class="line"> </span><br><span class="line">Checking GitLab ... Finished</span><br><span class="line">  </span><br><span class="line">然后稍等一会（如果启动gitlab后，访问出现500，这是因为redis等程序还没完全启动，等一会儿访问就ok了），再次登录Gitlab，就会发现之前误删除的test项目已经恢复了！</span><br><span class="line">  </span><br><span class="line">另外：Gitlab迁移与恢复一样，但是要求两个GitLab版本号一致</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;备份跟还原-GitLab&quot;&gt;&lt;a href=&quot;#备份跟还原-GitLab&quot; class=&quot;headerlink&quot; title=&quot;备份跟还原 GitLab&quot;&gt;&lt;/a&gt;备份跟还原 GitLab&lt;/h3&gt;&lt;p&gt;应用数据备份创建的压缩文件包含了数据库，所有代码仓库和所有附
      
    
    </summary>
    
    
      <category term="gitlab" scheme="http://yoursite.com/tags/gitlab/"/>
    
  </entry>
  
  <entry>
    <title>gitlab安装</title>
    <link href="http://yoursite.com/2019/01/18/gitlab%E5%AE%89%E8%A3%85/"/>
    <id>http://yoursite.com/2019/01/18/gitlab安装/</id>
    <published>2019-01-18T02:52:55.000Z</published>
    <updated>2019-01-18T03:37:11.724Z</updated>
    
    <content type="html"><![CDATA[<h2 id="gitLab安装"><a href="#gitLab安装" class="headerlink" title="gitLab安装"></a>gitLab安装</h2><h3 id="1-配置系统防火墙-把HTTP和SSH端口开放"><a href="#1-配置系统防火墙-把HTTP和SSH端口开放" class="headerlink" title="1. 配置系统防火墙,把HTTP和SSH端口开放"></a>1. 配置系统防火墙,把HTTP和SSH端口开放</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@gitlab ~]# /etc/init.d/iptables stop</span><br><span class="line">[root@gitlab ~]# yum install curl openssh-server postfix cronie</span><br><span class="line">[root@gitlab ~]# service postfix start</span><br><span class="line">[root@gitlab ~]# chkconfig postfix on</span><br><span class="line">[root@gitlab ~]# lokkit -s http -s ssh</span><br></pre></td></tr></table></figure><h3 id="2-下载gitlab的rpm安装包"><a href="#2-下载gitlab的rpm安装包" class="headerlink" title="2.下载gitlab的rpm安装包"></a>2.下载gitlab的rpm安装包</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@gitlab ~]# rpm -ivh gitlab-ce-9.4.5-ce.0.el6.x86_64.rpm --force</span><br></pre></td></tr></table></figure><blockquote><p>安装后的gitlab默认路径是/opt/gitlab（程序路径）、 /var/opt/gitlab（配置文件路径）。</p></blockquote><h4 id="issue"><a href="#issue" class="headerlink" title="issue"></a>issue</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost zxg]# rpm -ivh gitlab-ce-10.0.0-ce.0.el6.x86_64.rpm --force</span><br><span class="line">warning: gitlab-ce-10.0.0-ce.0.el6.x86_64.rpm: Header V4 RSA/SHA1 Signature, key ID f27eab47: NOKEY</span><br><span class="line">error: Failed dependencies:</span><br><span class="line">policycoreutils-python is needed by gitlab-ce-10.0.0-ce.0.el6.x86_64</span><br></pre></td></tr></table></figure><h4 id="solve"><a href="#solve" class="headerlink" title="solve"></a>solve</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install policycoreutils-python</span><br></pre></td></tr></table></figure><h3 id="3-配置端口号"><a href="#3-配置端口号" class="headerlink" title="3. 配置端口号"></a>3. 配置端口号</h3><blockquote><p>vi /etc/gitlab/gitlab.rb<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">external_url &apos;http://10.60.45.87&apos;</span><br><span class="line">nginx[&apos;listen_port&apos;] = 8081</span><br></pre></td></tr></table></figure></p></blockquote><h3 id="4-生效"><a href="#4-生效" class="headerlink" title="4. 生效"></a>4. 生效</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gitlab-ctl reconfigure</span><br><span class="line">gitlab-ctl start</span><br><span class="line">gitlab-ctl status</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;gitLab安装&quot;&gt;&lt;a href=&quot;#gitLab安装&quot; class=&quot;headerlink&quot; title=&quot;gitLab安装&quot;&gt;&lt;/a&gt;gitLab安装&lt;/h2&gt;&lt;h3 id=&quot;1-配置系统防火墙-把HTTP和SSH端口开放&quot;&gt;&lt;a href=&quot;#1-配置系统
      
    
    </summary>
    
    
      <category term="gitlab" scheme="http://yoursite.com/tags/gitlab/"/>
    
  </entry>
  
  <entry>
    <title>gitLab_Runner</title>
    <link href="http://yoursite.com/2019/01/18/gitLab-Runner/"/>
    <id>http://yoursite.com/2019/01/18/gitLab-Runner/</id>
    <published>2019-01-18T01:27:52.000Z</published>
    <updated>2019-01-18T03:45:19.108Z</updated>
    
    <content type="html"><![CDATA[<h3 id="gitLab-之-Runner"><a href="#gitLab-之-Runner" class="headerlink" title="gitLab 之 Runner"></a>gitLab 之 Runner</h3><blockquote><p>Gitlab CI Runner安装以及如何跑项目构建流程。</p></blockquote><h4 id="1-安装、注册并启动Gitlab-Runner"><a href="#1-安装、注册并启动Gitlab-Runner" class="headerlink" title="1. 安装、注册并启动Gitlab Runner"></a>1. 安装、注册并启动Gitlab Runner</h4><p>Gitlab Runner安装方式有两种，一种是直接二进制文件安装，一种是基于docker镜像安装。 </p><h5 id="1-下载对应操作系统的二进制包，我这里使用的是mac版本"><a href="#1-下载对应操作系统的二进制包，我这里使用的是mac版本" class="headerlink" title="1. 下载对应操作系统的二进制包，我这里使用的是mac版本"></a>1. 下载对应操作系统的二进制包，我这里使用的是mac版本</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo curl --output /usr/local/bin/gitlab-runner https://gitlab-ci-multi-runner-downloads.s3.amazonaws.com/latest/binaries/gitlab-ci-multi-runner-darwin-amd64</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> # For RHEL/CentOS/Fedora</span><br><span class="line"> curl -L https://packages.gitlab.com/install/repositories/runner/gitlab-runner/script.rpm.sh | sudo bash</span><br><span class="line">``` </span><br><span class="line">##### 2. 给gitlab-runner赋可执行权限</span><br></pre></td></tr></table></figure><p>sudo chmod +x /usr/local/bin/gitlab-runner<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">##### 3 注册runner</span><br></pre></td></tr></table></figure></p><h1 id="gitlab-runner-register"><a href="#gitlab-runner-register" class="headerlink" title="gitlab-runner register"></a>gitlab-runner register</h1><p>Please enter the gitlab-ci coordinator URL:</p><h1 id="示例：http-gitlab-alibaba-inc-com-ci"><a href="#示例：http-gitlab-alibaba-inc-com-ci" class="headerlink" title="示例：http://gitlab.alibaba-inc.com/ci"></a>示例：<a href="http://gitlab.alibaba-inc.com/ci" target="_blank" rel="noopener">http://gitlab.alibaba-inc.com/ci</a></h1><p>Please enter the gitlab-ci token for this runner:</p><h1 id="xxxxxx"><a href="#xxxxxx" class="headerlink" title="xxxxxx"></a>xxxxxx</h1><p>Please enter the gitlab-ci description for this runner:</p><h1 id="示例：qd-api-runner"><a href="#示例：qd-api-runner" class="headerlink" title="示例：qd_api_runner"></a>示例：qd_api_runner</h1><p>Please enter the gitlab-ci tags for this runner (comma separated):</p><h1 id="示例：hwy"><a href="#示例：hwy" class="headerlink" title="示例：hwy"></a>示例：hwy</h1><p>Whether to run untagged builds [true/false]:</p><h1 id="true"><a href="#true" class="headerlink" title="true"></a>true</h1><p>Please enter the executor: docker, parallels, shell, kubernetes, docker-ssh, ssh, virtualbox, docker+machine, docker-ssh+machine:</p><h1 id="docker"><a href="#docker" class="headerlink" title="docker"></a>docker</h1><p>Please enter the default Docker image (e.g. ruby:2.1):</p><h1 id="maven-3-jdk-8"><a href="#maven-3-jdk-8" class="headerlink" title="maven:3-jdk-8"></a>maven:3-jdk-8</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">说明： </span><br><span class="line">1. gitlab ci的地址以及token，从你要配置该runner到哪个项目，就去gitlab下该项目首页右侧设置—》CI/CD Pipelines—》Specific Runners下可以找到。 </span><br><span class="line">2. gitlab-ci tags这个很重要，在项目构建流程yaml文件里面指定tag，就是匹配使用哪个tag的runner，这里我定义了hwy，回头再配置文件里面就指定这个tag。 </span><br><span class="line">3. executor：执行者可以有很多种，这里我们使用docker，方便构建执行。 </span><br><span class="line">4. Docker image：构建Docker image时填写的image名称，根据项目代码语言不同，指定不同的镜像。我这里项目是java语言的，所以我使用官方maven:3-jdk-8镜像。</span><br><span class="line"></span><br><span class="line">##### 4. 安装并启动gitlab-runner</span><br></pre></td></tr></table></figure><p>cd ~<br>gitlab-runner install<br>gitlab-runner start<br><code>`</code></p><p>注册gitlab-runner时，提示报错：<br>GitLab Runner &gt;= 9.0 can be used ONLY with GitLab CE/EE &gt;= 9.0<br>这个因为默认gitlab runner安装时最新版的，与我们正在使用的gitlab版本不匹配，那么我们找到匹配的gitlab-runner版本安装即可，从这里我们可以找到 Runner和GitLab CE / EE兼容性列表<br>有时runner会连接不上，或者在项目仓库-&gt;设置-&gt;runner里呈灰色，这有可能是runner机器上没有启动gitlab-runner引起的，可以执行ps -ef | grep gitlab看看是否存在gitlab-runner的进程，如果没有则执行gitlab-runner start 命令启动runner服务。<br>若已经配置好了gitlab-runner了，执行commit，pipeline状态一直是pending，并且提示：<br>This build is stuck, because the project doesn’t have any runners online assigned to it. Go to Runners page<br>这个是因为未找到对应的runner导致的，原因一是有可能gitlab-runner注册失败，原因二有可能是.gitlab-ci.yml配置文件里面tags没有匹配到已注册可用的runner。<br>每次maven:3-jdk-8去执行build和test都会重新拉取镜像，下载依赖的jar包，比较耗时耗资源。这是因为docker image每次构建都是在独立的container里， maven的 .m2文件并不会被多次构建公用，这里我们可以通过修改gitlab-runner的配置，将maven .m2目录加到volumes中，并增加镜像拉取规则（默认是从远程拉取镜像，这里修改为优先获取本地镜像，不存在时才去远程拉取镜像）</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;gitLab-之-Runner&quot;&gt;&lt;a href=&quot;#gitLab-之-Runner&quot; class=&quot;headerlink&quot; title=&quot;gitLab 之 Runner&quot;&gt;&lt;/a&gt;gitLab 之 Runner&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt;Gitla
      
    
    </summary>
    
    
      <category term="gitLab" scheme="http://yoursite.com/tags/gitLab/"/>
    
  </entry>
  
  <entry>
    <title>docker_redis</title>
    <link href="http://yoursite.com/2019/01/16/docker-redis/"/>
    <id>http://yoursite.com/2019/01/16/docker-redis/</id>
    <published>2019-01-16T11:08:22.000Z</published>
    <updated>2019-01-16T11:26:25.132Z</updated>
    
    <content type="html"><![CDATA[<p>docker pull redis</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --name myredis -d redis</span><br></pre></td></tr></table></figure><p>-d d 参数让容器在后台运行</p><p>####启动客户端<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ docker run --rm -it --link myredis:redis redis /bin/bash</span><br><span class="line">root@ca38735c5747:/data# redis-cli -h redis -p 6379</span><br><span class="line">redis:6379&gt; ping</span><br><span class="line">PONG</span><br><span class="line">redis:6379&gt; set &quot;abc&quot; 123</span><br><span class="line">OK</span><br><span class="line">redis:6379&gt; get &quot;abc&quot;</span><br><span class="line">&quot;123&quot;</span><br><span class="line">redis:6379&gt; exit</span><br><span class="line">root@ca38735c5747:/data# exit</span><br><span class="line">exit</span><br></pre></td></tr></table></figure></p><blockquote><p>能将两个容器神奇地连接在一起，是通过 docker run 命令的 –link myredis:redis 参数实<br>现的。这个参数告诉 Docker 把新容器与现存的“myredis”容器连接起来，并且在新容器<br>中以“redis”作为“myredis”容器的主机名。为了实现这一点，Docker 会在新容器中的 /<br>etc/hosts 里添加一个新条目，把“redis”指向“myredis”的 IP 地址。这样就能够在执行<br>redis-cli 的时候直接使用“redis”作为主机名，而不需想办法找出或传递 Redis 容器的 IP<br>地址给 redis-cli。</p></blockquote><blockquote><p>我们怎样才能做数据的持久保存和备份？为此，我们不会使用标准的容器文件系统，而是需要一个能够让容器与主机，或容器<br>与其他容器之间轻松共享数据的方式。Docker 通过数据卷（volume）的概念提供了这种<br>方式。数据卷是直接在主机挂载的文件或目录，不属于常规联合文件系统的一部分。</p></blockquote><p>第一种是在 Dockerfile 里使用 VOLUME 指令，第二种是在执行<br>docker run 的时候使用 -v 参数。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ docker run --rm -it --link myredis:redis redis /bin/bash</span><br><span class="line">root@09a1c4abf81f:/data# redis-cli -h redis -p 6379</span><br><span class="line">redis:6379&gt; set &quot;persistence&quot; &quot;test&quot;</span><br><span class="line">OK</span><br><span class="line">redis:6379&gt; save</span><br><span class="line">OK</span><br><span class="line">redis:6379&gt; exit</span><br><span class="line">root@09a1c4abf81f:/data# exit</span><br><span class="line">exit</span><br><span class="line">$ docker run --rm --volumes-from myredis -v $(pwd)/backup:/backup \</span><br><span class="line"> debian cp /data/dump.rdb /backup/</span><br><span class="line">$ ls backup</span><br><span class="line">dump.rdb</span><br></pre></td></tr></table></figure></p><p>$ docker stop myredis<br>myredis<br>$ docker rm -v myredis</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;docker pull redis&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td cl
      
    
    </summary>
    
    
      <category term="docker" scheme="http://yoursite.com/tags/docker/"/>
    
  </entry>
  
</feed>
